---
title: 'data analysis: joint attention (BOSCA)'
author: "Nico Bast"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: yes
    number_sections: yes
    theme: cerulean
    code_folding: hide
  word_document:
    toc: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
#chunk settings
knitr::opts_chunk$set(echo = TRUE)

#define paths
#project path
project_path<-'C:/Users/Nico/PowerFolders/project_BOSCA_battery' #equals to local Github rep

#required packages
require(ggplot2) #visualization
require(kableExtra) #tables

require(hexbin) #visualization
require(RColorBrewer) #custom color palettes
require(gridExtra) #multi panel figures

require(gganimate) #animated gaze behavior
require(gifski) #gif renderer - animate()

require(lme4) #linear mixed models
require(emmeans) #marginalized means
require(lmerTest) #p-values for linear mixed models
require(MuMIn) # pseudo R-squared
require(performance) #r²_nakagawa - marginalized and conditionalk R² 

require(pwrss) #power calculation

#set include visualization to FALSE for faster knitting
include_visualization<-TRUE
render_animation<-TRUE

#for faster visualization, select fraction of data to visualize (default 0.1 = 10%)
fraction_to_sample<-0.1 
sampling_factor<-1/fraction_to_sample 

#set theme
theme_set(theme_bw())

##predefined function --> converts log odds to probability
logit2prob <- function(logit){
  odds <- exp(logit)
  prob <- odds / (1 + odds)
  return(prob)
}

#color palettes
# - rndm = Dark2

```

- working title: longitudinal development of reactive joint attention after early intervention in autistic preschoolers

# prepare data sets

- data is loaded from different files and converted to a format that can be analyzed in linear mixed models

## load data

- data on local machine
- available on reasonable request

```{r load data}

#eye-tracking data: file created by script: data_preprocessing_jointattention
load(paste0(project_path,'/data/all_data_preprocessed_FINAL_jointatt_140324.Rdata'))
## --> includes´
## df_trial --> per-trial - includes main outcome measures
## df_jointatt --> per-sample preprocessed data
rm(demogr)


#load demographic separately
load("C:/Users/nico/PowerFolders/data_AFFIP/demogr_total_0424.Rdata")
### --> includes
## demogra --> demographic & questionnaire data from databases (RCT,FU)
## et_demogr --> ET data quality

```

## fix data

- data entry with implausible naming

```{r}

demogr$ID_Studie<-gsub('-K','_K',demogr$ID_Studie)

```

## data overview

### date of measurement

```{r}

#### - date of measurement #####

ggplot(demogr[!is.na(demogr$t_date),],aes(x=t_date,fill=t))+geom_histogram(bins=50)+theme_bw()+
  labs(title='assessments across study runtime')

ggplot(demogr[!is.na(demogr$t_date),],aes(x=ID_Bado,y=t_date,color=t))+
  geom_point()+theme_bw()+labs(x='participant')+labs(title='assessments across study runtime')

ggplot(demogr[!is.na(demogr$t_date),],aes(x=ID_Bado,y=t_date,color=t))+
  geom_point()+theme_bw()+labs(x='participant')+labs(title='assessments across study runtime')+facet_grid(~group)

```

### age at assessment

```{r}

hist(demogr$t_age)

```

## extract baseline IQ

-   IQ was assessed at T1 and thus is not mathced down below, so retrieve this IQ data and assign it to ID numbers

```{r}

#allign naming of IDs with demogr
demogr$ID_Studie_merge<-gsub('_K','',demogr$ID_Studie)
demogr$ID_Studie_merge<-gsub('-K','',demogr$ID_Studie_merge)

#table(demogr$ID_Studie_merge)

#extract IQ data
baseline_nonverbal_iq<-demogr$nonverbal_iq[demogr$t=='T1']
baseline_verbal_iq<-demogr$verbal_iq[demogr$t=='T1']
pic<-demogr$ID_Studie_merge[demogr$t=='T1']

df_iq_baseline<-data.frame(pic,baseline_nonverbal_iq,baseline_verbal_iq)

```

## rename timepoint variable

-define timepoint variable so that non-autistic and autistic allign in timepoints:
- e.g. T2 was baseline in autistic, K was baseline in non-autistic --> all T2

```{r}

#in per-trial data
df_trial$t<-with(df_trial,dplyr::case_when(timepoint=='T2' ~ 'T2',
                                    timepoint=='T4' ~ 'T4',
                                    timepoint=='T6' ~ 'T6',
                                    timepoint=='K' ~ 'T2',
                                    timepoint=='K_FU' ~ 'FU2',
                                    timepoint=='FU2' ~ 'FU2',
                                    timepoint=='FU3' ~ 'FU3',
                                    ))


#in per-sample data
df_jointatt$t<-with(df_jointatt,dplyr::case_when(timepoint=='T2' ~ 'T2',
                                    timepoint=='T4' ~ 'T4',
                                    timepoint=='T6' ~ 'T6',
                                    timepoint=='K' ~ 'T2',
                                    timepoint=='K_FU' ~ 'FU2',
                                    timepoint=='FU2' ~ 'FU2',
                                    timepoint=='FU3' ~ 'FU3',
                                    ))


df_jointatt$t<-ordered(df_jointatt$t, levels = c("T2", "T4", "T6", 'FU2', 'FU3'))
df_trial$t<-ordered(df_trial$t, levels = c("T2", "T4", "T6", 'FU2', 'FU3'))


```

## merge demographic data to trial data

```{r merge it}

#### --> merge df_timepoint to df_trial ####
df_trial<-merge(df_trial[,names(df_trial)!='group'],demogr,
                by.x=c('pic','t'),
                by.y=c('ID_Studie_merge','t'))
#### --> merge df_baseline_iq to df_trial ####
df_trial<-merge(df_trial,df_iq_baseline,by='pic',all.x=T)

```

## rename gender

- from German names to international

```{r}

#rename variables
df_trial$gender<-ifelse(df_trial$Geschlecht_Index=='weiblich','f','m')

```


## define group variable

-   3 groups: 
  - autistic (early intervention: A-FFIP) 
  - autistic (early intervention as usual: EAIU), 
  - non-autistic

```{r group definition}

df_trial$rndm<-ifelse(df_trial$group=='non autistic','non autistic',df_trial$rndm)
df_trial$rndm<-as.factor(df_trial$rndm)
levels(df_trial$rndm)<-c('autistic A-FFIP','autistic TAU','non autistic')

demogr$rndm<-ifelse(demogr$group=='non autistic','non autistic',demogr$rndm)
demogr$rndm<-as.factor(demogr$rndm)
levels(demogr$rndm)<-c('autistic A-FFIP','autistic TAU','non autistic')

```

## merge demographic data to eye-tracking sample data

- data derived from eye-tracker is merged with corresponding database entries

```{r merge to raw data}

df_sample<-df_trial[!duplicated(interaction(df_trial$t,df_trial$pic)),]
df_sample<-df_sample[,names(df_sample) %in% c('pic','t','rndm','gender','t_age','baseline_nonverbal_iq')]

df_jointatt<-merge(df_jointatt,df_sample,by = c('pic','t'),all.x=T)

```

## reduce raw eye-tracking data set

- remove timepoint FU3 as very few cases
- remove data that has no group (rndm is na)

```{r}

df_jointatt<-df_jointatt[!is.na(df_jointatt$rndm),]
df_jointatt<-df_jointatt[df_jointatt$t!='FU3',]

```

## aggregate eye-tracking metrics

- based on per-trial data  
- mean or sum value per timepoint

```{r aggregate ET data}

pic<-as.factor(with(df_trial,by(pic,droplevels(interaction(pic,t)),head,n=1)))
levels(pic)<-levels(df_trial$pic)

t<-as.factor(with(df_trial,by(t,droplevels(interaction(pic,t)),head,n=1)))
levels(t)<-levels(df_trial$t)

rndm<-as.factor(with(df_trial,by(rndm,droplevels(interaction(pic,t)),head,n=1)))
levels(rndm)<-levels(df_trial$rndm)

gender<-as.factor(with(df_trial,by(gender,droplevels(interaction(pic,t)),head,n=1)))

df_boolean<-aggregate(df_trial[,names(df_trial) %in% c('target_missed',
                                                       'rja_any',
                                                       'rja_occurances')],
          by=list(df_trial$pic,df_trial$t),
          FUN=sum,na.rm=T)


df_metrics<-aggregate(df_trial[,names(df_trial) %in% c('baseline_pd','rpd_middle',
                                           'time_to_target',"gazeduration_head",
                                           'gazeduration_target','rja_duration','no_data',                                     'saccade_duration','fixation_duration','t_age','nonverbal_iq')],
          by=list(df_trial$pic,df_trial$t),
          FUN=mean,na.rm=T)



df_et_agg<-cbind(pic,t,rndm,gender,df_metrics,df_boolean)

```

## completed measurements by participants

```{r}

df_measurements<-with(df_trial,table(pic,t))
pic<-row.names(df_measurements)
col_names<-colnames(df_measurements)

df_measurements<-data.frame(matrix(ifelse(df_measurements %in% c(8,16),T,F),nrow=143,ncol=5))
colnames(df_measurements)<-col_names
row.names(df_measurements)<-pic

FU_complete<-apply(df_measurements,1,function(x){
  dplyr::case_when(x['T2'] &  x['FU2'] ~ TRUE,
                   !x['T2'] ~ FALSE,
                   !x['FU2'] ~ FALSE)
})

RCT_complete<-apply(df_measurements,1,function(x){
  dplyr::case_when(x['T2'] & x['T4'] & x['T6'] ~ TRUE,
                   !x['T4'] ~ FALSE,
                   !x['T6'] ~ FALSE)
})

df_measurements<-data.frame(pic,df_measurements,FU_complete,RCT_complete)
df_measurements<-df_measurements[,names(df_measurements) %in% c('pic','FU_complete','RCT_complete')]

table(df_measurements$RCT_complete)
table(df_measurements$FU_complete)

#merge to existing dataframes
df_trial<-merge(df_trial,df_measurements,by='pic')
df_et_agg<-merge(df_et_agg,df_measurements,by='pic')


```

# matching

- more female participants in non autistic group
- exclude female non autistic participants that have no complete assessments

```{r}

df_sample<-df_trial[df_trial$t=='T2',]
df_sample<-df_sample[!duplicated(df_sample$pic),]

with(df_sample,table(gender,FU_complete,rndm))

exclude_ids<-as.character(with(df_sample,pic[!FU_complete & gender=='f' & rndm=='non autistic']))
exclude_ids<-exclude_ids[!is.na(exclude_ids)]

exclude_ids

#exclude data in data sets
df_trial<-df_trial[!(df_trial$pic %in% exclude_ids),]
df_jointatt<-df_jointatt[!(df_jointatt$pic %in% exclude_ids),]
df_et_agg<-df_et_agg[!(df_et_agg$pic %in% exclude_ids),]
demogr<-demogr[!(demogr$ID_Studie_merge %in% exclude_ids),]

```

- exclude ids in non-autistic group with highest non verbal IQ 
- currently not evaluated

```{r, eval=F}

df_sample<-demogr[demogr$t %in% c('T1','T2'),]
df_sample<-df_sample[!duplicated(df_sample$ID_Studie_merge),]

tail(sort(df_sample$nonverbal_iq[df_sample$rndm=='non autistic']))

exclude_ids<-as.character(df_sample$ID_Studie_merge[df_sample$nonverbal_iq >= 110 & df_sample$rndm=='non autistic' & df_sample$Geschlecht_Index == 'weiblich' & df_sample$t_age < 36])

exclude_ids<-exclude_ids[!is.na(exclude_ids)]
exclude_ids

#exclude data in data sets
df_trial<-df_trial[!(df_trial$pic %in% exclude_ids),]
df_jointatt<-df_jointatt[!(df_jointatt$pic %in% exclude_ids),]
df_et_agg<-df_et_agg[!(df_et_agg$pic %in% exclude_ids),]
demogr<-demogr[!(demogr$ID_Studie_merge %in% exclude_ids),]

```

# clean workspace

```{r}

rm(df_metrics)
rm(df_boolean)
rm(df_iq_baseline)
rm(df_measurements)

```

# exclude participants with low data quality

- more than 50% missing data per trial
- two participants at follow up in TAU group

```{r}

interaction(df_et_agg$pic,df_et_agg$t)[df_et_agg$no_data>0.5]

exclude_ids<-c('069_fu2','073_fu2')

df_trial<-df_trial[!df_trial$id %in% exclude_ids,]
df_sample<-df_sample[!df_sample$id %in% exclude_ids,]

exclude_ids<-c('069.FU2','073.FU2')
df_et_agg$id<-interaction(df_et_agg$pic,df_et_agg$t)
demogr$id<-interaction(demogr$ID_Studie,demogr$t)

df_et_agg<-df_et_agg[!df_et_agg$id %in% exclude_ids,]
demogr<-demogr[!demogr$id %in% exclude_ids,]

```

# sample description

-   based on df_trial and df_et_agg
-   by timepoint and by group

## descriptive table - 3 groups

-   statistics table of non-autistic, autistic TAU, and autistic A-FFIP (treatment) groups
-   T4 timepoint (+6months) not considered for reasons of model parsimony

```{r sample description - table 1}

#one value per timepoint and participant
df_sample<-df_trial[!duplicated(interaction(df_trial$t,df_trial$pic)),]
with(df_sample,table(rndm,t))

#function for descriptives of metric variables
fun_return_descriptive<-function(variable,group,rounding=2,scaling=1){
  mean_values<-by(variable,group,function(x){round(mean(x,na.rm=T),rounding)})
  sd_values<-by(variable,group,function(x){round(sd(x,na.rm=T),rounding)})
  min_values<-by(variable,group,function(x){round(min(x,na.rm=T),rounding)})
  max_values<-by(variable,group,function(x){round(max(x,na.rm=T),rounding)})
  mean_values<-mean_values*scaling
  sd_values<-sd_values*scaling
  min_values<-min_values*scaling
  max_values<-max_values*scaling
  paste0(mean_values,'/',sd_values,' ','[',min_values,'-',max_values,']')
}

#interested variables on group level:
n_timepoint<-sapply(with(df_sample[df_sample$t %in% c('T2','FU2'),],by(t,rndm,table)),
                    function(x){paste(x[1],'/',x[4])})
       
gender_sample<-sapply(with(df_sample[df_sample$t=='T2',],by(gender,rndm,table)),
       function(x){paste(x[1],'/',x[2])})

age_baseline<-with(df_sample[df_sample$t=='T2',],fun_return_descriptive(t_age,rndm))
age_followup<-with(df_sample[df_sample$t=='FU2',],fun_return_descriptive(t_age,rndm))

iq_baseline<-with(demogr[demogr$t=='T1',],fun_return_descriptive(nonverbal_iq,rndm))
iq_followup<-with(demogr[demogr$t %in% c('FU','FU2'),],fun_return_descriptive(nonverbal_iq,rndm))

demogr$developmental_age<-with(demogr,nonverbal_iq * t_age / 100)
diq_baseline<-with(demogr[demogr$t=='T1',],fun_return_descriptive(developmental_age,rndm))
diq_followup<-with(demogr[demogr$t %in% c('FU','FU2'),],fun_return_descriptive(developmental_age,rndm))

srs_baseline<-with(demogr[demogr$t %in% c('T1','T2'),],
                   fun_return_descriptive(srs16_sum,rndm))
srs_followup<-with(demogr[demogr$t %in% c('FU2','FU'),],
                   fun_return_descriptive(srs16_sum,rndm))

rbsr_baseline<-with(demogr[demogr$t %in% c('T1','T2'),],
                   fun_return_descriptive(RBSR_ges,rndm))
rbsr_followup<-with(demogr[demogr$t %in% c('FU2','FU'),],
                   fun_return_descriptive(RBSR_ges,rndm))

cbcl_baseline<-with(demogr[demogr$t %in% c('T1','T2'),],
                   fun_return_descriptive(CBCL_T_GES,rndm))
cbcl_followup<-with(demogr[demogr$t %in% c('FU2','FU'),],
                   fun_return_descriptive(CBCL_T_GES,rndm))

asd_severity_baseline<-with(df_sample[df_sample$t %in% c('T2') & df_sample$rndm!='non autistic',],
                   fun_return_descriptive(Severity_Gesamt,rndm))
asd_severity_followup<-with(df_sample[df_sample$t %in% c('FU2') & df_sample$rndm!='non autistic',],
                   fun_return_descriptive(Severity_Gesamt,rndm))

# escs_rja_baseline<-with(demogr[demogr$t %in% c('T2','T1') & demogr$rndm!='non autistic',],
#                    fun_return_descriptive(Total_RJA,rndm))
# escs_ija_baseline<-with(demogr[demogr$t %in% c('T2','T1') & demogr$rndm!='non autistic',],
#                    fun_return_descriptive(Total_IJA,rndm))


###ET variables to one value per timepoint
rja_baseline<-with(df_et_agg[df_et_agg$t %in% c('T2'),],
                   fun_return_descriptive(rja_any/16*100,rndm))
rja_followup<-with(df_et_agg[df_et_agg$t %in% c('FU2'),],
                   fun_return_descriptive(rja_any/16*100,rndm))

rja_s_baseline<-with(df_et_agg[df_et_agg$t %in% c('T2'),],
                   fun_return_descriptive(rja_duration,rndm))
rja_s_followup<-with(df_et_agg[df_et_agg$t %in% c('FU2'),],
                   fun_return_descriptive(rja_duration,rndm))

pd_baseline<-with(df_et_agg[df_et_agg$t %in% c('T2'),],
                   fun_return_descriptive(baseline_pd,rndm))
pd_followup<-with(df_et_agg[df_et_agg$t %in% c('FU2'),],
                   fun_return_descriptive(baseline_pd,rndm))

sepr_baseline<-with(df_et_agg[df_et_agg$t %in% c('T2'),],
                   fun_return_descriptive(rpd_middle,rndm))
sepr_followup<-with(df_et_agg[df_et_agg$t %in% c('FU2'),],
                   fun_return_descriptive(rpd_middle,rndm))

fixation_baseline<-with(df_et_agg[df_et_agg$t %in% c('T2'),],
                   fun_return_descriptive(fixation_duration,rndm))
fixation_followup<-with(df_et_agg[df_et_agg$t %in% c('FU2'),],
                   fun_return_descriptive(fixation_duration,rndm))

dataquality_baseline<-with(df_et_agg[df_et_agg$t %in% c('T2'),],
                   fun_return_descriptive(no_data*100,rndm))
dataquality_followup<-with(df_et_agg[df_et_agg$t %in% c('FU2'),],
                   fun_return_descriptive(no_data*100,rndm))

#create one data frame
descriptives_table<-rbind(
  n_timepoint,
  gender_sample,
  age_baseline,
  age_followup,
  diq_baseline,
  diq_followup,
  iq_baseline,
  iq_followup,
  srs_baseline,
  srs_followup,
  rbsr_baseline,
  rbsr_followup,
  cbcl_baseline,
  cbcl_followup,
  asd_severity_baseline,
  asd_severity_followup,
  #escs_rja_baseline,
  #escs_ija_baseline,
  rja_baseline,
  rja_followup,
  rja_s_baseline,
  rja_s_followup,
  pd_baseline,
  pd_followup,
  sepr_baseline,
  sepr_followup,
  fixation_baseline,
  fixation_followup,
  dataquality_baseline,
  dataquality_followup
)

#change NA values
descriptives_table<-gsub('NA/NA \\[NA-NA\\]','-',x=descriptives_table)

#group comparisons
age_b_p<-with(df_sample[df_sample$t=='T2' & df_sample$rndm!='non autistic',],t.test(t_age~rndm))[['p.value']]
age_f_p<-with(df_sample[df_sample$t=='FU2' & df_sample$rndm!='non autistic',],t.test(t_age~rndm))[['p.value']]
iq_b_p<-with(demogr[demogr$t=='T1' & demogr$rndm!='non autistic',],t.test(nonverbal_iq~rndm))[['p.value']]
iq_f_p<-with(demogr[demogr$t %in% c('FU','FU2') & demogr$rndm!='non autistic',],t.test(nonverbal_iq~rndm))[['p.value']]
srs_b_p<-with(demogr[demogr$t %in% c('T1','T2') & demogr$rndm!='non autistic',],t.test(srs16_sum~rndm))[['p.value']]
srs_b_f<-with(demogr[demogr$t %in% c('FU','FU2') & demogr$rndm!='non autistic',],t.test(srs16_sum~rndm))[['p.value']]
cbcl_b_p<-with(demogr[demogr$t %in% c('T1','T2') & demogr$rndm!='non autistic',],t.test(CBCL_T_GES~rndm))[['p.value']]
cbcl_f_p<-with(demogr[demogr$t %in% c('FU','FU2') & demogr$rndm!='non autistic',],t.test(CBCL_T_GES~rndm))[['p.value']]
ados_b_p<-with(df_sample[df_sample$t=='T2' & df_sample$rndm!='non autistic',],t.test(Severity_Gesamt~rndm))[['p.value']]
ados_b_f<-with(df_sample[df_sample$t=='FU2' & df_sample$rndm!='non autistic',],t.test(Severity_Gesamt~rndm))[['p.value']]

var_names<-c(
  'timepoints (baseline/follow-up)',
  'biological sex (female/male)',
  'age (m)',
  '',
  'developmental age (m)',
  '',
  'nonverbal IQ',
  '',
  'SRS-16 total',
  '',
  'RBSR total',
  '',
  'CBCL total t-score',
  '',
  'ADOS CSS',
  '',
  'RJA likelihood (%)',
  '',
  'RJA duration (s)',
  '',
  'baseline pupil size (mm)',
  '',
  'stimulus-evoked pupillary response (mm)',
  '',
  'total fixation duration (s)',
  '',
  'mean missing data (%)',
  ''
  )

timepoint_labels<-c(
  '',
  '',
  'baseline',
  'follow-up',
  'baseline',
  'follow-up',
  'baseline',
  'follow-up',
  'baseline',
  'follow-up',
  'baseline',
  'follow-up',
  'baseline',
  'follow-up',
  'baseline',
  'follow-up',
  'baseline',
  'follow-up',
  'baseline',
  'follow-up',
  'baseline',
  'follow-up',
  'baseline',
  'follow-up',
  'baseline',
  'follow-up',
  'baseline',
  'follow-up'
)

descriptives_table<-cbind(var_names,timepoint_labels,descriptives_table)

table_sample<-descriptives_table %>%
  kbl(caption = "Table 1. Sample description: autistic and non-autistic  groups at baseline and follow-up.",
      col.names = c('','timepoints','A-FFIP - autistic individuals','EIAU - autistic individuals','non-autistic individuals'),
      row.names = F) %>%
  kable_classic(full_width = F, html_font = "Cambria") %>%
  #adds solid line after every row
  row_spec(seq(0, nrow(descriptives_table), 2)[-1], extra_css = "border-bottom: 1px solid;")%>%
  footnote(general = "Mean / SD [Min - Max]")

table_sample

save_kable(table_sample, file=paste0(project_path,'/output/tables/table1_sampledescription.html'))


```

## descriptive table - autism groups

```{r sample description - table 2}

#one value per timepoint and participant
df_sample<-df_trial[!duplicated(interaction(df_trial$t,df_trial$pic)) &
                      df_trial$rndm!='non autistic' & 
                      df_trial$t %in% c('T2','T4','T6','FU2'),]

#remove non.autistic from variable levels
df_sample$rndm<-droplevels(df_sample$rndm)
df_sample$t<-droplevels(df_sample$t)

with(df_sample,table(rndm,t))

#function for descriptives of metric variables
fun_return_descriptive<-function(variable,group,rounding=2,scaling=1){
  mean_values<-by(variable,group,function(x){round(mean(x,na.rm=T),rounding)})
  sd_values<-by(variable,group,function(x){round(sd(x,na.rm=T),rounding)})
  min_values<-by(variable,group,function(x){round(min(x,na.rm=T),rounding)})
  max_values<-by(variable,group,function(x){round(max(x,na.rm=T),rounding)})
  mean_values<-mean_values*scaling
  sd_values<-sd_values*scaling
  min_values<-min_values*scaling
  max_values<-max_values*scaling
  paste0(mean_values,'/',sd_values,' ','[',min_values,'-',max_values,']')
}

#interested variables on group level:
n_timepoint<-sapply(with(df_sample,by(t,rndm,table)),
                    function(x){paste(x[1],'/',x[3],'/',x[4])})

gender_sample<-sapply(with(df_sample[df_sample$t=='T2',],by(gender,rndm,table)),
       function(x){paste(x[1],'/',x[2])})

age_T2<-with(df_sample[df_sample$t=='T2',],fun_return_descriptive(t_age,rndm))
age_T4<-with(df_sample[df_sample$t=='T4',],fun_return_descriptive(t_age,rndm))
age_T6<-with(df_sample[df_sample$t=='T6',],fun_return_descriptive(t_age,rndm))
age_FU<-with(df_sample[df_sample$t=='FU2',],fun_return_descriptive(t_age,rndm))


iq_T2<-with(demogr[demogr$t=='T1' & demogr$rndm!='non autistic',],fun_return_descriptive(nonverbal_iq,rndm))[1:2]
iq_T4<-with(demogr[demogr$t=='T4' & demogr$rndm!='non autistic',],fun_return_descriptive(nonverbal_iq,rndm))[1:2]
iq_T6<-with(demogr[demogr$t=='T6' & demogr$rndm!='non autistic',],fun_return_descriptive(nonverbal_iq,rndm))[1:2]
iq_FU<-with(demogr[demogr$t=='FU2' & demogr$rndm!='non autistic',],fun_return_descriptive(nonverbal_iq,rndm))[1:2]

srs_T2<-with(df_sample[df_sample$t=='T2',],fun_return_descriptive(srs16_sum,rndm))
srs_T4<-with(df_sample[df_sample$t=='T4',],fun_return_descriptive(srs16_sum,rndm))
srs_T6<-with(df_sample[df_sample$t=='T6',],fun_return_descriptive(srs16_sum,rndm))
srs_FU<-with(df_sample[df_sample$t=='FU2',],fun_return_descriptive(srs16_sum,rndm))

rbsr_T2<-with(df_sample[df_sample$t=='T2',],fun_return_descriptive(RBSR_ges,rndm))
rbsr_T4<-with(df_sample[df_sample$t=='T4',],fun_return_descriptive(RBSR_ges,rndm))
rbsr_T6<-with(df_sample[df_sample$t=='T6',],fun_return_descriptive(RBSR_ges,rndm))
rbsr_FU<-with(df_sample[df_sample$t=='FU2',],fun_return_descriptive(RBSR_ges,rndm))

# boscc_T2<-with(df_sample[df_sample$t=='T2',],fun_return_descriptive(BOSCC_Average_Total,rndm))
# boscc_T4<-with(df_sample[df_sample$t=='T4',],fun_return_descriptive(BOSCC_Average_Total,rndm))
# boscc_T6<-with(df_sample[df_sample$t=='T6',],fun_return_descriptive(BOSCC_Average_Total,rndm))
# boscc_T6<-with(df_sample[df_sample$t=='FU2',],fun_return_descriptive(BOSCC_Average_Total,rndm))


cbcl_T2<-with(df_sample[df_sample$t=='T2',],fun_return_descriptive(CBCL_T_GES,rndm))
cbcl_T4<-with(df_sample[df_sample$t=='T4',],fun_return_descriptive(CBCL_T_GES,rndm))
cbcl_T6<-with(df_sample[df_sample$t=='T6',],fun_return_descriptive(CBCL_T_GES,rndm))
cbcl_FU<-with(df_sample[df_sample$t=='FU2',],fun_return_descriptive(CBCL_T_GES,rndm))

##ESCS RJA
escs_rja_T2<-with(df_sample[df_sample$t=='T2',],fun_return_descriptive(Total_RJA,rndm))
escs_rja_T6<-c('-','-')
escs_rja_FU<-c('-','-')

###ET variables to one value per timepoint
rja_T2<-with(df_et_agg[df_et_agg$t %in% c('T2') & df_et_agg$rndm!='non autistic',],
                   fun_return_descriptive(rja_any/16*100,rndm))[1:2]
rja_T4<-with(df_et_agg[df_et_agg$t %in% c('T4') & df_et_agg$rndm!='non autistic',],
                   fun_return_descriptive(rja_any/16*100,rndm))[1:2]
rja_T6<-with(df_et_agg[df_et_agg$t %in% c('T6') & df_et_agg$rndm!='non autistic',],
                   fun_return_descriptive(rja_any/16*100,rndm))[1:2]
rja_FU<-with(df_et_agg[df_et_agg$t %in% c('FU2') & df_et_agg$rndm!='non autistic',],
                   fun_return_descriptive(rja_any/16*100,rndm))[1:2]

rja_s_T2<-with(df_et_agg[df_et_agg$t %in% c('T2') & df_et_agg$rndm!='non autistic',],
                   fun_return_descriptive(rja_duration,rndm))[1:2]
rja_s_T4<-with(df_et_agg[df_et_agg$t %in% c('T4') & df_et_agg$rndm!='non autistic',],
                   fun_return_descriptive(rja_duration,rndm))[1:2]
rja_s_T6<-with(df_et_agg[df_et_agg$t %in% c('T6') & df_et_agg$rndm!='non autistic',],
                   fun_return_descriptive(rja_duration,rndm))[1:2]
rja_s_FU<-with(df_et_agg[df_et_agg$t %in% c('FU2') & df_et_agg$rndm!='non autistic',],
                   fun_return_descriptive(rja_duration,rndm))[1:2]



pd_T2<-with(df_et_agg[df_et_agg$t %in% c('T2') & df_et_agg$rndm!='non autistic',],
                   fun_return_descriptive(baseline_pd,rndm))[1:2]
pd_T4<-with(df_et_agg[df_et_agg$t %in% c('T4') & df_et_agg$rndm!='non autistic',],
                   fun_return_descriptive(baseline_pd,rndm))[1:2]
pd_T6<-with(df_et_agg[df_et_agg$t %in% c('T6') & df_et_agg$rndm!='non autistic',],
                   fun_return_descriptive(baseline_pd,rndm))[1:2]
pd_FU<-with(df_et_agg[df_et_agg$t %in% c('FU2') & df_et_agg$rndm!='non autistic',],
                   fun_return_descriptive(baseline_pd,rndm))[1:2]

sepr_T2<-with(df_et_agg[df_et_agg$t %in% c('T2') & df_et_agg$rndm!='non autistic',],
                   fun_return_descriptive(rpd_middle,rndm))[1:2]
sepr_T4<-with(df_et_agg[df_et_agg$t %in% c('T4') & df_et_agg$rndm!='non autistic',],
                   fun_return_descriptive(rpd_middle,rndm))[1:2]
sepr_T6<-with(df_et_agg[df_et_agg$t %in% c('T6') & df_et_agg$rndm!='non autistic',],
                   fun_return_descriptive(rpd_middle,rndm))[1:2]
sepr_FU<-with(df_et_agg[df_et_agg$t %in% c('FU2') & df_et_agg$rndm!='non autistic',],
                   fun_return_descriptive(rpd_middle,rndm))[1:2]

fixation_T2<-with(df_et_agg[df_et_agg$t %in% c('T2') & df_et_agg$rndm!='non autistic',],
                   fun_return_descriptive(fixation_duration,rndm))[1:2]
fixation_T4<-with(df_et_agg[df_et_agg$t %in% c('T4') & df_et_agg$rndm!='non autistic',],
                   fun_return_descriptive(fixation_duration,rndm))[1:2]
fixation_T6<-with(df_et_agg[df_et_agg$t %in% c('T6') & df_et_agg$rndm!='non autistic',],
                   fun_return_descriptive(fixation_duration,rndm))[1:2]
fixation_FU<-with(df_et_agg[df_et_agg$t %in% c('FU2') & df_et_agg$rndm!='non autistic',],
                   fun_return_descriptive(fixation_duration,rndm))[1:2]



dataquality_T2<-with(df_et_agg[df_et_agg$t %in% c('T2') & df_et_agg$rndm!='non autistic',],
                   fun_return_descriptive(no_data*100,rndm))[1:2]
dataquality_T4<-with(df_et_agg[df_et_agg$t %in% c('T4') & df_et_agg$rndm!='non autistic',],
                   fun_return_descriptive(no_data*100,rndm))[1:2]
dataquality_T6<-with(df_et_agg[df_et_agg$t %in% c('T6') & df_et_agg$rndm!='non autistic',],
                   fun_return_descriptive(no_data*100,rndm))[1:2]

dataquality_FU<-with(df_et_agg[df_et_agg$t %in% c('FU2') & df_et_agg$rndm!='non autistic',],
                   fun_return_descriptive(no_data*100,rndm))[1:2]


#create one data frame
descriptives_table<-rbind(
  n_timepoint,
  gender_sample,
  age_T2,
  #age_T4,
  age_T6,
  age_FU,
  iq_T2,
  #iq_T4,
  iq_T6,
  iq_FU,
  srs_T2,
  #srs_T4,
  srs_T6,
  srs_FU,
  rbsr_T2,
  #rbsr_T4,
  rbsr_T6,
  rbsr_FU,
  # boscc_T2,
  # boscc_T4,
  # boscc_T6,
  cbcl_T2,
  #cbcl_T4,
  cbcl_T6,
  cbcl_FU,
  escs_rja_T2,
  escs_rja_T6,
  escs_rja_FU,
  rja_T2,
  #rja_T4,
  rja_T6,
  rja_FU,
  rja_s_T2,
  #rja_s_T4,
  rja_s_T6,
  rja_s_FU,
  pd_T2,
  #pd_T4,
  pd_T6,
  pd_FU,
  sepr_T2,
  #sepr_T4,
  sepr_T6,
  sepr_FU,
  fixation_T2,
  #fixation_T4,
  fixation_T6,
  fixation_FU,
  dataquality_T2,
  #dataquality_T4,
  dataquality_T6,
  dataquality_FU
)

var_names<-c(
  'timepoints (BL/+12M/+36M)',
  'biological sex (female/male)',
  'age (m)',
  #'',
  '',
  '',
  'nonverbal IQ',
  #'',
  '',
  '',
  'SRS-16 total',
  #'',
  '',
  '',
  'RBSR total',
  #'',
  '',
  '',
  # 'BOSCC total',
  # '',
  # '',
  'CBCL total t-score',
  #'',
  '',
  '',
  'ESCS RJA (%)',
  '',
  '',
  'RJA likelihood (%)',
  #'',
  '',
  '',
  'RJA duration (s)',
  #'',
  '',
  '',
  'baseline pupil size (mm)',
  #'',
  '',
  '',
  'stimulus-evoked pupillary response (mm)',
  #'',
  '',
  '',
  'total fixation duration (s)',
  #'',
  '',
  '',
  'mean missing data (0-1)',
  #'',
  '',
  ''
  )

timepoint_labels<-c(
  '',
  '',
  'baseline',
  #'+6 months',
  '+12 months',
  '+36 months',
  'baseline',
  #'+6 months',
  '+12 months',
  '+36 months',
  'baseline',
  #'+6 months',
  '+12 months',
  '+36 months',
  'baseline',
  #'+6 months',
  '+12 months',
  '+36 months',
  'baseline',
  #'+6 months',
  '+12 months',
  '+36 months',
  'baseline',
  #'+6 months',
  '+12 months',
  '+36 months',
  'baseline',
  #'+6 months',
  '+12 months',
  '+36 months',
  # 'baseline',
  # '+6 months',
  # '+12 months',
  'baseline',
  #'+6 months',
  '+12 months',
  '+36 months',
  'baseline',
  #'+6 months',
  '+12 months',
  '+36 months',
  'baseline',
  #'+6 months',
  '+12 months',
  '+36 months',
  'baseline',
  #'+6 months',
  '+12 months',
  '+36 months',
  'baseline',
  #'+6 months',
  '+12 months',
  '+36 months'
)

descriptives_table<-cbind(var_names,timepoint_labels,descriptives_table)

table_sample<-descriptives_table %>%
  kbl(caption = "Table 2. Sample description: autistic groups at baseline (BL), end-of-treatment (+12M), and follow-up (+36M).",
      col.names = c('','timepoints','A-FFIP - autistic individuals','EAIU - autistic individuals'),
      row.names = F) %>%
  kable_classic(full_width = F, html_font = "Cambria") %>%
  #adds solid line after every row
  row_spec(c(2,seq(2, nrow(descriptives_table), 3)[-c(1)]), extra_css = "border-bottom: 1px solid;") %>%
  footnote(general = "Mean / SD [Min - Max]")

table_sample

save_kable(table_sample, file=paste0(project_path,'/output/tables/table2_sampledescription_autismgroups.html'))



```

## autism symptom severity

-comparison of autism symptom severity

```{r visualize symptom severity}

#one value per timepoint and participant
df_sample<-df_trial[!duplicated(interaction(df_trial$t,df_trial$pic)) &
                      df_trial$t %in% c('T1','T2'),]

#custom color
custom_color<-c('autistic A-FFIP' = brewer.pal(3,'Dark2')[1], 
                "autistic TAU" = brewer.pal(3,'Dark2')[2],
                "non autistic" = brewer.pal(3,'Dark2')[3]
                )

table(df_sample$rndm)

with(df_sample,psych::describe(Severity_Gesamt))

#distribution ADOS
g1<-ggplot(df_sample[df_sample$group=='autistic' & !is.na(df_sample$Severity_Gesamt),], 
           aes(x=Severity_Gesamt,fill=rndm)) + 
  geom_bar(color=1) + 
  labs(x="ADOS CSS", y="occurances",title="ADOS-2") +
  theme(plot.title = element_text(hjust = 0.5))+
  scale_fill_manual(values = custom_color[1:2])+
  facet_wrap(~rndm)
#distribution BOSCC
g2<-ggplot(df_sample[df_sample$group=='autistic' & !is.na(df_sample$BOSCC_Average_Total),], 
           aes(x=BOSCC_Average_Total,fill=rndm)) + 
  geom_histogram(bins=10,color=1) + 
  labs(x="BOSCC Total (averaged)", y="occurances",title="BOSCC") +
  theme(plot.title = element_text(hjust = 0.5))+
  scale_fill_manual(values = custom_color[1:2])+
  facet_wrap(~rndm)
#distribution SRS
g3<-ggplot(demogr[!is.na(demogr$srs16_sum) & demogr$t %in% c('T1','T2') & !is.na(demogr$rndm),], 
       aes(x=rndm, y=srs16_sum, fill=rndm)) + 
  geom_violin()+
  labs(x="group", y="SRS-16 raw score",title="SRS-16") +
  scale_fill_manual(values=custom_color)+
  theme(plot.title = element_text(hjust = 0.5))

grid.arrange(g1,g2,g3)

```

## date of assessment variation

- provide variation of date of assessment for section "procedure" in manuscript
- in months: first = end-of-treatment - baseline, second: follow-up - baseline

```{r}

demogr_ass<-demogr[demogr$t %in% c('T2','T6','FU2') & substr(demogr$ID_Studie,1,3) %in% unique(df_trial$pic),]
demogr_ass<-demogr_ass[,names(demogr_ass) %in% c('ID_Studie','t','Gruppe','t_date')]
demogr_ass$t<-droplevels(as.factor(demogr_ass$t))

demogr_ass<-reshape2::dcast(demogr_ass,ID_Studie+Gruppe~t,
                          value.var = 't_date')


timespan_T6_T2<-with(demogr_ass,T6-T2)/30
by(timespan_T6_T2,demogr_ass$Gruppe,sd,na.rm=T)

timespan_FU2_T2<-with(demogr_ass,FU2-T2)/30
by(timespan_FU2_T2,demogr_ass$Gruppe,sd,na.rm=T)
by(timespan_FU2_T2,demogr_ass$Gruppe,range,na.rm=T)


```


# data inspection 
## eye-tracking calibration quality

```{r calibration_quality}

t(table(et_demogr$calib_quality)) %>%
  kbl(caption = "eye tracking data quality") %>%
  kable_paper("hover", full_width = T)


```

## available data sets

derived from entries in demographic data files

```{r available data sets}

#database entries that have ET data
t(table(demogr$ID_Studie %in% et_demogr$ID,demogr$t)) %>%
  kbl(caption = "data base entries with eye-tracking") %>%
  kable_paper("hover", full_width = T)

 print('Eye-tracking is missing foir these that have database entries:')
 unique(demogr$ID_Studie[!(demogr$ID_Studie %in% et_demogr$ID)])

#ET data that have database entries
t(table(et_demogr$ID %in% demogr$ID_Studie,et_demogr$t)) %>%
  kbl(caption = "eye-tracking with data base entries") %>%
  kable_paper("hover", full_width = T)

```

derived from per-sample eye-tracking data

```{r}

#individual data sets
length(unique(df_jointatt$id)) #data of 265 measurement timepoints after matching (April 2024)
length(unique(df_jointatt$pic)) #data of 120 participants after matching (April 2024)

    # #available eye tracking data
    # by(df_jointatt$id,df_jointatt$timepoint,function(x){length(unique(x))})
    # ##--> after matching (September 2022): K = 44, T2 = 51, T4 = 44, T6 = 32
    # ##--> without matching (March 2023): K = 65, T2 = 62, T4 = 53, T6 = 47, K_FU = 20, FU2 = 15, FU3 = 2
    # ##--> without matching (March 2024): K = 75, T2 = 62, T4 = 53, T6 = 47, K_FU = 26, FU2 = 25, FU3 = 12

```

## data distribution

based on preprocessed eye-tracking data

```{r}

#missing data in preprocessed pupil dilation data
table(is.na(df_jointatt$rpd))[2]/sum(table(is.na(df_jointatt$rpd))) #--> 43.2 missing data in pupil data
table(is.na(df_jointatt$gazepos_x))[2]/sum(table(is.na(df_jointatt$gazepos_x))) #--> 51.8% missing in gaze x
table(is.na(df_jointatt$gazepos_y))[2]/sum(table(is.na(df_jointatt$gazepos_y))) #--> 56.0% missing  in gaze y

#gaze behavior
table(df_jointatt$saccade) #roughly 10% saccade data is plausible
table(df_jointatt$fixation) #roughly 90% fixation data is plausible

#data distribution --> exclude implausible
hist(df_jointatt$pd,30,main='pupil size (mm)')
#hist(df_jointatt$baseline_pd,30,main='baseline pupil size (mm)') #pupil size in first 500ms of a trial
hist(df_jointatt$rpd[df_jointatt$rpd<2 & df_jointatt$rpd>-2],30,main='pupillary response') #--> implausible outlier #pupil response (baseline pd - pupil size)
hist(df_jointatt$gaze_speed,30,main='gaze velocity (degrees/s)')
hist(df_jointatt$gaze_accel,30,main='gaze acceleration (degrees/s²)')
hist(df_jointatt$gazepos_y,30,main='gaze location on x-axis (0-1)')
hist(df_jointatt$gazepos_x,30,main='gaze location on y-axis (0-1)')

# #VALID TRIALS by participants
# hist(as.numeric(with(df_jointatt[df_jointatt$fixation,],
#                      by(index_trial,id,function(x){length(unique(x))}))),xlab='trials',main='trials with fixation data by participant')

```

# data visualization

utilizes per-sample eye-tracking data

## gaze behavior

```{r, eval=include_visualization}
### --> visualize gaze behavior (for INSAR 2023 abstract) ####

##define percentage of data sampling for visualization
subsample<-sample(1:nrow(df_jointatt),nrow(df_jointatt)/sampling_factor) 
#--> select 10% of data for faster plotting (faster rendering)

custom_palette<-brewer.pal(8,'Purples')[c(1,4,8)]

##gaze locations across video
ggplot(df_jointatt[subsample,],aes(x=gazepos_x,y=gazepos_y))+
  geom_hex(bins=100)+
  scale_fill_gradientn(colours=custom_palette)+
  ylim(1,0)+xlim(0,1)+coord_fixed(ratio = 9/16)+
  #scale_fill_viridis_c()+
  labs(title='gaze behavior across trials')

    #heatmap between timepoints and groups for joint attention phase
    ggplot(df_jointatt[df_jointatt$ts_event>1000 &
                         df_jointatt$ts_event<2100,],aes(x=gazepos_x,y=gazepos_y))+
    #geom_hex(bins=100)+
    stat_density_2d(aes(fill=after_stat(density)), n=50, geom = "raster", contour = FALSE)+
    scale_fill_gradientn(colours=custom_palette)+
    ylim(1,0)+xlim(0,1)+coord_fixed(ratio = 9/16)+
    facet_grid(rndm~t)+theme_bw()
    
  
# #before rja cueing onset
# ggplot(df_jointatt[df_jointatt$ts_event<1000,],aes(x=gazepos_x,y=gazepos_y))+
#   stat_density_2d(aes(fill=after_stat(density)), n=100, geom = "raster", contour = FALSE) +
#   #geom_hex(bins=100)+ # based on counts, so difficult to compare groups
#   scale_fill_gradientn(colours=custom_palette)+
#   ylim(1,0)+xlim(0,1)+coord_fixed(ratio = 9/16)+
#   facet_grid(rndm~t)+
#   labs(title='gaze behavior before RJA cueing onset (first 3.3s)')+
#   theme_void()
# 
# #after RJA cueing onset
# ggplot(df_jointatt[df_jointatt$ts_event>1300 & df_jointatt$ts_event<1600,],aes(x=gazepos_x,y=gazepos_y))+
#   geom_hex(bins=100)+
#   #stat_density_2d(aes(fill=after_stat(density)), n=50, geom = "raster", contour = FALSE) +
#   scale_fill_gradientn(colours=custom_palette)+
#   ylim(1,0)+xlim(0,1)+coord_fixed(ratio = 9/16)+
#   facet_grid(rndm~t)+
#   labs(title='gaze behavior after RJA cueing onset (4.3 - 5.3s)')+
#   theme_void()
# 
# #late RJA
# ggplot(df_jointatt[subsample & df_jointatt$ts_event>2000 & df_jointatt$ts_event<3000,],aes(x=gazepos_x,y=gazepos_y))+
#   geom_hex(bins=100)+
#   #stat_density_2d(aes(fill=after_stat(density)), n=50, geom = "raster", contour = FALSE) +
#   scale_fill_gradientn(colours=custom_palette)+
#   ylim(1,0)+xlim(0,1)+coord_fixed(ratio = 9/16)+
#   facet_wrap(~timepoint)+
#   labs(title='late RJA - (8.6 - 10s)')+
#   heme_void()
# 
# #late RJA
# ggplot(df_jointatt[subsample & df_jointatt$ts_event>2700 & df_jointatt$ts_event<3300,],aes(x=gazepos_x,y=gazepos_y))+
#   geom_hex(bins=30)+
#   #stat_density_2d(aes(fill=after_stat(density)), n=50, geom = "raster", contour = FALSE) +
#   scale_fill_gradientn(colours=custom_palette)+
#   ylim(1,0)+xlim(0,1)+coord_fixed(ratio = 9/16)+
#   facet_wrap(~timepoint)+
#   labs(title='late RJA - (9 - 11s)')+
#   heme_void()

```

### animate gaze behavior (gifs)

- render animation

```{r, eval=render_animation}

#transition variable in animation:
frame_rate<-300
df_jointatt$time_s<-with(df_jointatt,round(ts_event/frame_rate,1))

#BETWEEN GROUPS
animated_gaze<-ggplot(df_jointatt,aes(x=gazepos_x,y=gazepos_y))+
  stat_density_2d(aes(fill=after_stat(density)), n=50, geom = "raster", contour = FALSE) +
  #geom_bin_2d(bins=100)+
  #scale_fill_gradientn(colours=rev(rainbow(3)))+
  scale_fill_gradientn(colours = c("black","white","red","orange","yellow","green","blue"),
                         values = c(1.0,0.5,0.2,0.15,0.1,0.05,0))+
  ylim(1,0)+xlim(0,1)+coord_fixed(ratio = 9/16)+
  #facet_wrap(~timepoint)+
  facet_grid(position+rndm~t)+
  theme_bw()+
  theme(legend.position="none")+
  #animation specific
  #transition_time(time_s)+facet_wrap(~timepoint)
  transition_time(time_s)+
  ggtitle('Gaze behavior between groups','time: {frame_time}')

#save animation
gif_1<-animate(animated_gaze, duration = 10, fps = 10, width = 800, height = 800, 
               renderer = gifski_renderer())
anim_save(file=paste0(project_path,'/output/gaze_animation_time_2ddensity_position300424.gif'),gif_1)


#ACROSS GROUPS - overall plot 
animated_gaze<-ggplot(df_jointatt[df_jointatt$time_s>9 & df_jointatt$time_s<11,],
                      aes(x=gazepos_x,y=gazepos_y))+
  stat_density_2d(aes(fill=after_stat(density)), n=50, geom = "raster", contour = FALSE) +
  #geom_bin_2d(bins=100)+
  #scale_fill_gradientn(colours=rev(rainbow(3)))+
  scale_fill_gradientn(colours = c("black","white","red","orange","yellow","green","blue"),
                       values = c(1.0,0.5,0.2,0.15,0.1,0.05,0))+
  ylim(1,0)+xlim(0,1)+coord_fixed(ratio = 9/16)+
  #facet_wrap(~timepoint)+
  theme_bw()+
  theme(legend.position="none")+
  #animation specific
  #transition_time(time_s)+facet_wrap(~timepoint)
  transition_time(time_s)+
  ggtitle('Gaze behavior across groups','time: {frame_time}')

gif_1<-animate(animated_gaze, duration = 10, fps = 10, width = 800, height = 800, 
               renderer = gifski_renderer())
anim_save(file=paste0(project_path,'/output/gaze_animation_las2s.gif'),gif_1)


#BETWEEN GROUPS - between target position
animated_gaze<-ggplot(df_jointatt,
                      aes(x=gazepos_x,y=gazepos_y))+
  stat_density_2d(aes(fill=after_stat(density)), n=50, geom = "raster", contour = FALSE) +
  scale_fill_gradientn(colours = c("black","white","red","orange","yellow","green","blue"),
                       values = c(1.0,0.5,0.2,0.15,0.1,0.05,0))+
  ylim(1,0)+xlim(0,1)+coord_fixed(ratio = 9/16)+
  facet_grid(position~rndm)+
  theme_bw()+
  theme(legend.position="none")+
  #animation specific
  transition_time(time_s)+
  ggtitle(label = 'Gaze behavior between groups within trials',
          subtitle = 'time: {frame_time}')

gif_1<-animate(animated_gaze, duration = 10, fps = 10, width = 1920, height = 1080, 
               renderer = gifski_renderer())
anim_save(file=paste0(project_path,'/output/gaze_animation_by_group_and_target_position.gif'),gif_1)

```

#### first 3 seconds

```{r show gif1, out.width = '100%'}

knitr::include_graphics(paste0(project_path,'/gaze_animation_first3s.gif'), error = FALSE)


```

#### next 6 seconds

```{r show gif2, out.width = '100%'}

knitr::include_graphics(paste0(project_path,'/gaze_animation_next6s.gif'), error = FALSE)


```

#### last 2 seconds

```{r show gif3, out.width = '100%'}

knitr::include_graphics(paste0(project_path,'/gaze_animation_las2s.gif'), error = FALSE)


```

#### gaze behavior between groups

```{r show gifs, out.width = '100%'}

knitr::include_graphics(paste0(project_path,'/gaze_animation_time_2ddensity_position300424.gif'), error = FALSE)

```

## reactive joint attention (RJA)

```{r, eval=include_visualization}

##RJA
ggplot(df_jointatt,aes(x=rja_when/300))+
  geom_density(fill='grey',adjust=2)+
  labs(x='video duration (s)',y='RJA occurances (density)')+
  xlim(c(0,12))+
  geom_vline(xintercept=1)+geom_vline(xintercept=3.5,linetype='dashed')+
  geom_vline(xintercept=9.5,linetype='dashed')+
  labs(title='RJA across video stimuli')+
  theme_bw()

##RJA between timepoints and groups
ggplot(df_jointatt,
       aes(x=rja_when/300,group=t,fill=rndm))+
  geom_density(adjust=2)+
  labs(x='video duration (s)',y='RJA occurances (density)')+
  xlim(c(0,11))+
  geom_vline(xintercept=1)+geom_vline(xintercept=3.5,linetype='dashed')+
  geom_vline(xintercept=9.5,linetype='dashed')+
  scale_fill_brewer(palette='Dark2')+
  facet_grid(rndm~t)+theme_bw()

# figure with overlapping plots
ggplot(df_jointatt,
       aes(x=rja_when/300,group=interaction(t,rndm),fill=rndm))+
  geom_density(adjust=3,alpha=0.5)+
  labs(x='video duration (s)',y='RJA occurances (density)')+
  xlim(c(0,11))+
  geom_vline(xintercept=1)+geom_vline(xintercept=3.5,linetype='dashed')+
  geom_vline(xintercept=9.5,linetype='dashed')+
  scale_fill_brewer(palette='Dark2')+
  facet_grid(.~t)+theme_bw()


    # ##head gaze between timepoints
    # ggplot(df_jointatt,
    #        aes(x=gazehead_when/300,group=t,fill=rndm))+
    #   geom_density(adjust=2)+
    #   labs(x='video duration (s)',y='head gaze (density)')+
    #   xlim(c(0,11))+
    #   geom_vline(xintercept=1)+geom_vline(xintercept=4,linetype='dashed')+
    #   geom_vline(xintercept=10,linetype='dashed')+
    #   scale_fill_brewer(palette='Dark2')+
    #   facet_grid(rndm~t)+theme_bw()
    # 
    # ##head gaze between timepoints
    # ggplot(df_jointatt,
    #        aes(x=gazetarget_when/300,group=t,fill=rndm))+
    #   geom_density(adjust=2)+
    #   labs(x='video duration (s)',y='target gaze (density)')+
    #   xlim(c(0,11))+
    #   geom_vline(xintercept=1)+geom_vline(xintercept=4,linetype='dashed')+
    #   geom_vline(xintercept=10,linetype='dashed')+
    #   scale_fill_brewer(palette='Dark2')+
    #   facet_grid(rndm~t)+theme_bw()
    # 
    # ##RJA between conditions
    # ggplot(df_jointatt[!is.na(df_jointatt$gaze_top),],aes(x=ts_event,fill=gaze_top))+geom_bar(position = "fill")+
    #   labs(x='sample (1/300s)',y='proportion of all samples')+
    #   geom_vline(xintercept=450,lty=1,color='black')+
    #   geom_vline(xintercept=900,lty=2,color='blue')+
    #   geom_vline(xintercept=2700,lty=2,color='blue')+
    #   facet_grid(vars(position),vars(condition))+theme_bw()

```

## social attention - gaze head

- firugre interpretation:
  - no differences in initial social attention before joint attention cueing
  - non-autistic more social attention during joint attention phase
  - A-FFIP versus TAU at T4 and T6 with more 
  - A-FFIP versus TAU at follow-up with earlier socia attention during joint attention 

```{r social attention}

##social attention across video stimuli
ggplot(df_jointatt,aes(x=gazehead_when/300))+
  geom_density(fill='grey',adjust=2)+
  labs(x='video duration (s)',y='social attention occurances (density)')+
  xlim(c(0,12))+
  geom_vline(xintercept=1)+geom_vline(xintercept=3.5,linetype='dashed')+
  geom_vline(xintercept=9.5,linetype='dashed')+
  labs(title='social attention across video stimuli')+
  theme_bw()

##social attention between timepoints and groups
ggplot(df_jointatt,
       aes(x=gazehead_when/300,group=t,fill=rndm))+
  geom_density(adjust=2)+
  labs(x='video duration (s)',y='social attention  occurances (density)')+
  xlim(c(0,11))+
  geom_vline(xintercept=1)+geom_vline(xintercept=3.5,linetype='dashed')+
  geom_vline(xintercept=9.5,linetype='dashed')+
  scale_fill_brewer(palette='Dark2')+
  facet_grid(rndm~t)+theme_bw()

# figure with overlapping plots
ggplot(df_jointatt,
       aes(x=gazehead_when/300,group=interaction(t,rndm),fill=rndm))+
  geom_density(adjust=2,alpha=0.5)+
  labs(x='video duration (s)',y='social attention occurances (density)')+
  xlim(c(0,11))+
  geom_vline(xintercept=1)+geom_vline(xintercept=3.5,linetype='dashed')+
  geom_vline(xintercept=9.5,linetype='dashed')+
  scale_fill_brewer(palette='Dark2')+
  facet_grid(.~t)+theme_bw()


```



## baseline pupil size

- shows that BPS reflects arousal and not a luminance adaptation

```{r BPS, eval=include_visualization}

##define percentage of data sampling for visualization
subsample<-sample(1:nrow(df_jointatt),nrow(df_jointatt)/sampling_factor) 
df_jointatt_plot<-df_jointatt[subsample,]
#--> select 10% of data for faster plotting (faster rendering)

#select only attention grabber phase
df_jointatt_plot<-df_jointatt_plot[df_jointatt_plot$time_s<=1,]

## specific to groups
# ggplot(df_jointatt_plot,aes(x=ts_event/300,y=pd,
#                             group=rndm,color=rndm,fill=rndm))+
#   geom_smooth()+geom_vline(linetype=2,xintercept=0.5)+
#   labs(x='tme in trial (s)',y='pupil size (mm)')+
#   scale_fill_brewer(palette='Dark2')+ #custom color
#   scale_color_brewer(palette='Dark2')+ #custom color
#   labs(color='group',fill='group') #custom labels


ggplot(df_jointatt_plot,aes(x=ts_event/300,y=pd))+
  geom_smooth(color='black',fill='darkgrey')+
  geom_vline(linetype=2,xintercept=0.5)+
  labs(x='time in trial (s)',y='pupil size (mm)',title='E.) Baseline pupil size (BPS)')
 
  
```

## stimulus-evoked pupillary response

```{r SEPR, eval=include_visualization}

##define percentage of data sampling for visualization
subsample<-sample(1:nrow(df_jointatt),nrow(df_jointatt)/sampling_factor) 
df_jointatt_plot<-df_jointatt[subsample,]
#--> select 10% of data for faster plotting (faster rendering)

#select only gaze cued associated response
df_jointatt_plot<-df_jointatt_plot[df_jointatt_plot$time_s>=4 & df_jointatt_plot$time_s<=6,]

## group specific
# ggplot(df_jointatt_plot,aes(x=ts_event/300,y=pd,
#                             group=rndm,color=rndm,fill=rndm))+
#   geom_smooth(method="lm",formula=y ~ poly(x, 2, raw=TRUE))+
#   geom_vline(linetype=2,xintercept=c(4.5,5.5))+
#   labs(x='tme in trial (s)',y='pupil size (mm)')+
#   scale_fill_brewer(palette='Dark2')+ #custom color
#   scale_color_brewer(palette='Dark2')+ #custom color
#   labs(color='group',fill='group') #custom labels


ggplot(df_jointatt_plot,aes(x=ts_event/300,y=pd))+
  geom_smooth(color='black',fill='darkgrey')+
  geom_vline(linetype=2,xintercept=c(4.5,5.5))+
  labs(x='time in trial (s)',y='pupil size (mm)',title='F.) Stimulus-evoked pupillary response (SEPR)')
  


```



## pupil dilation

```{r, eval=include_visualization}

##define percentage of data sampling for visualization
subsample<-sample(1:nrow(df_jointatt),nrow(df_jointatt)/sampling_factor) 
#--> select 10% of data for faster plotting (faster rendering)


#visualize pupillary response progression (for INSAR 2023 abstract)
#pupil size progression - between conditions

#--> overall pupillary response
ggplot(df_jointatt[subsample,],aes(x=ts_event/300,y=rpd))+
  geom_smooth()+
  theme_bw()+
  labs(title='pupil size within trial',x='time (samples)',y='pupil size (mm)')+
  geom_vline(xintercept=1.1)+geom_vline(xintercept=3,linetype=2)+geom_vline(xintercept=9,linetype=2)
  ###--> pupillary response is not a six degree polynomial

#--> between timepoints x groups
ggplot(df_jointatt[subsample,],aes(x=ts_event/300,y=rpd,group=rndm,color=rndm))+
  geom_smooth(aes(fill=rndm))+theme_bw()+
  labs(title='pupil size within trial',x='video duration (s)',y='pupil size change (mm)')+
  geom_vline(xintercept=1)+geom_vline(xintercept=3,linetype='dashed')+
  geom_vline(xintercept=9,linetype='dashed')+
  scale_fill_brewer(palette='Dark2')+
  scale_color_brewer(palette='Dark2')+
  facet_grid(t~.)

## --> emphasize change within groups
ggplot(df_jointatt[subsample,],aes(x=ts_event/300,y=rpd,group=t,color=t))+
  geom_smooth(aes(fill=t))+theme_bw()+
  labs(title='pupil size within trial',x='video duration (s)',y='pupil size change (mm)')+
  geom_vline(xintercept=1)+geom_vline(xintercept=3,linetype='dashed')+
  geom_vline(xintercept=9,linetype='dashed')+
  scale_fill_brewer(palette='Reds')+
  scale_color_brewer(palette='Reds')+
  facet_grid(rndm~.)


# #--> between condition
# ggplot(df_jointatt[subsample,],aes(x=ts_event/300,y=rpd,group=condition,color=condition))+
#   geom_smooth()+theme_bw()+labs(title='pupil size within trial',x='time (samples)',y='pupil size (mm)')+
#   geom_vline(xintercept=1)+geom_vline(xintercept=3,linetype='dashed')+scale_color_brewer(palette='Dark2')
# 
# #--> between condition x timepoint
# ggplot(df_jointatt[subsample,],aes(x=ts_event,y=rpd,group=timepoint,color=timepoint))+
#   geom_smooth()+theme_bw()+labs(title='pupil size within trial',x='time (samples)',y='pupil size (mm)')+
#   geom_vline(xintercept=450)+geom_vline(xintercept=900)+facet_wrap(~condition)
#   #--> intense: only t2 has attenuated response / mild: K response is stronger than t2/t4/t6
# 
# #-> condition x group
# ggplot(df_jointatt,aes(x=ts_event,y=rpd,group=interaction(condition,group),color=condition,linetype=group))+
#   geom_smooth(method='lm', formula = y ~ x + poly(x,6))+theme_bw()+labs(title='pupil size within trial',x='time (samples)',y='pupil size (mm)')+
#   geom_vline(xintercept=450)+geom_vline(xintercept=900)

```

# correlation table

```{r, eval=F}

res <- Hmisc::rcorr(as.matrix(df_et_agg[,names(df_et_agg) %in% c("baseline_pd",
                                                          "rpd_middle",
                                                          "rja_any",
                                                          "rja_duration",
                                                          "target_missed",
                                                          "no_data",
                                                          "fixation_duration",
                                                          "t_age",
                                                          "nonverbal_iq"
                                                          )]))

round(res$r,2)
round(res$P,2)

corrplot::corrplot(corr= res$r, p.mat= res$P, method = 'number',
                   type = "upper", order = "hclust",
                   sig.level = 0.001, insig = 'blank',
                   tl.col = "black", tl.srt = 45)


```

# data analysis

- overall findings: PERFORMANCE
  - rja likelihood within groups: A-FFIp and non-autistic improve with likelihood, but not TAU
  - rja likelihood: A-FFIP has a higher likelihood than TAU at FU, no difference at baseline 
  - rja likelihood between autism groups: A-FFIp improves T2-T6, but TAU does not
  
- overall findings: NEUROPHYSIOLOGICAL RESPONSE
  - higher baseline PD is associated with LOWER pupillary response, RJA duration and likelihood
  - at FU: TAU with higher baseline PD than A-FFIP and non autistic, no difference at baseline
  - pupillary response increases RJA likelihood (and head attention)
  - higher pupillary response in TAU during FU compared to A-FFIP/non-autistic, not at baseline
    - this difference is not there for early and late pupillary response
    
- Cascades: change in RJA likelihood from T2 to T6 is assoicated with change in SRS score    

## task condition effects

### task condition effects

- no effects
- thus, not considered as covariates or fixed effects

```{r}

glmm<-glmer(rja_any~condition+
            (1|pic)+(1|index_trial),data=df_trial[df_trial$t %in% c('T2','FU2'),],family='binomial')

anova(glmm)

glmm<-glmer(rja_any~stimulus+
            (1|pic)+(1|index_trial),data=df_trial[df_trial$t %in% c('T2','FU2'),],family='binomial')

anova(glmm)

glmm<-glmer(rja_any~position+
            (1|pic)+(1|index_trial),data=df_trial[df_trial$t %in% c('T2','FU2'),],family='binomial')

anova(glmm)


```

### task effects on baseline PD

- covariates of task properites, participant characteristics have no effect 
- only a higher missing data is associated with higher baseline PD
--> use data quality as covariate in models on arousal?

```{r}

lmm<-lmer(baseline_pd~condition+stimulus+position+ #task properties
                  t_age+gender+baseline_nonverbal_iq+ #participant covariates
                  no_data+fixation_duration+ #data quality
                  (1|pic)+(1|index_trial),data=df_trial[df_trial$t %in% c('T2','FU2'),])
      
anova(lmm)
fixef(lmm)

```

## RJA association with ESCS data

- small positive association of RJA in eye-tracking and behavioral observation of RJA

```{r}

# df_escs<-merge(dplyr::select(df_sample,Total_RJA,pic),
#             dplyr::select(df_et_agg[df_et_agg$t=='T2',],pic,rja_any),by='pic')
# 
# 
# df_escs<-merge(dplyr::select(demogr,Total_RJA,ID_Studie,t),
#             dplyr::select(df_et_agg[df_et_agg$t %in% c('T2','T4'),],pic,rja_any,t),
#             by.x=list('ID_Studie','t'),
#             by.y=list('pic','t'))

df_escs_1<-dplyr::select(demogr,Total_RJA,ID_Studie,t)
df_escs_1$pic<-as.factor(df_escs_1$ID_Studie)
df_escs_2<-dplyr::select(df_et_agg[df_et_agg$t %in% c('T2','T4'),],pic,rja_any,t)

df_escs<-merge(df_escs_1,df_escs_2,
               by=c('pic','t'))

ggplot(df_escs,aes(x=rja_any/16*100,y=Total_RJA))+geom_point(aes(color=t))+geom_smooth(method='lm',color='black')+
  labs(x='Eye-tracking: RJA likelihood (%)',y='ESCS: RJA likelihood (%)')

hist(df_escs$rja_any)
hist(df_escs$Total_RJA)
#table(df_escs$Total_RJA)

#cor.test(df_escs$rja_any,df_escs$Total_RJA,method='pearson')

lmm<-lmer(scale(rja_any)~scale(Total_RJA)+(1|pic),df_escs)
summary(lmm)
confint(lmm, 'scale(Total_RJA)', level=0.95)

```

## RJA likelihood

- developmental model - between 3 groups: 
  - A-FFIP has a higher likelihood than TAU at FU, no difference at T2
  - --> within groups: A-FFIp and non-autistic improve with likelihood, but not TAU
  - non autistic still with higher likelihood
  
- intervention model - between autism groups
 - A-FFIP group improves from T2-T6 but not the TAU group


### treatment model - in autism groups

- increase of RJA likelihood from baseline to end-of-treatment in A-FFIp but not TAU

```{r}
### in autism groups ####

glmm<-glmer(rja_any~t*rndm+
            (1|pic)+(1|index_trial),data=df_trial[df_trial$t %in% c('T2','T6') & 
                                                    df_trial$rndm!='non autistic',],family='binomial')
#model fit
r2_nakagawa(glmm)  

#random effect distribution
hist(scale(ranef(glmm)$pic),10)

#planned contrasts
confint(contrast(emmeans(glmm,~t|rndm,type = "response"),'revpairwise'))
emmeans(glmm,~t|rndm,type = "response")
contrast(emmeans(glmm,~t|rndm,type = "response"),'revpairwise',adjust='none')
###--> improvement of RJA likelihood in A-FFIP group

#comparsion at timepoints
contrast(emmeans(glmm,~rndm+t,type = "response"),'pairwise')[c(1,6),]
confint(contrast(emmeans(glmm,~rndm+t,type = "response"),'pairwise',adjust='none'))[c(1,6),]

```

### developmental model - in all three groups

- between 3 groups: 
  - A-FFIP has a higher likelihood than TAU at FU, no difference at T2
  - non autistics still with higher likelihood
  - within groups: A-FFIp and non-autistic improve with likelihood, but not TAU

```{r RJA_likelihood_3groups}

#any
glmm<-glmer(rja_any~t*rndm+
            (1|pic)+(1|index_trial),data=df_trial[df_trial$t %in% c('T2','FU2'),],family='binomial')

#model fit
r2_nakagawa(glmm)  

#random effect distribution --> saved as supplement
hist(scale(ranef(glmm)$pic),10)

#means at baseline
emmeans(glmm,~rndm|t,type = "response")

#planned contrasts
confint(contrast(emmeans(glmm,~t|rndm,type = "response"),'revpairwise'))
contrast(emmeans(glmm,~t|rndm,type = "response"),'revpairwise')

# comparsion at timepoints
contrast(emmeans(glmm,~rndm+t,type = "response"),'pairwise',adjust='none')[13,]
confint(contrast(emmeans(glmm,~rndm+t,type = "response"),'pairwise',adjust='none'))[13,]

contrast(emmeans(glmm,~rndm+t,type = "response"),'pairwise',adjust='none')[c(2,6)]
confint(contrast(emmeans(glmm,~rndm+t,type = "response"),'pairwise',adjust='none')[c(2,6)])

contrast(emmeans(glmm,~rndm+t,type = "response"),'pairwise',adjust='none')[c(14,15)]
confint(contrast(emmeans(glmm,~rndm+t,type = "response"),'pairwise',adjust='none')[c(14,15)])

```

### RJA baseline as predictor

- baseline RJA likelihood is investigated as predictor of RJA at end-of-treatment and follow-up
- is only relevant in the developmental model and specific to the non-autistic group

```{r}

# df_et_agg_rja<-df_et_agg[,names(df_et_agg) %in% c('pic','t','rja_any','rndm')]
# df_et_agg_rja<-reshape2::dcast(df_et_agg_rja,pic+rndm~t)
# lm<-lm(FU2~T2*rndm,data=df_et_agg_rja)  
# anova(lm)  
# 
# df_et_agg_rja<-df_trial[,names(df_trial) %in% c('pic','t','rja_any','rndm')]
# df_et_agg_rja<-reshape2::dcast(df_et_agg_rja,pic+rndm~t,value.var='rja_any',fun.aggregate=sum)
# lm<-lm(FU2~T2*rndm,data=df_et_agg_rja)  
# anova(lm)  


#TEST IN GLMM

# ## random intercept model limited to one random intercept, choose best:
# glmm1<-glmer(T6~T2*rndm+(1|pic),data=df_et_agg_rja[df_et_agg_rja$rndm!='non autistic',],family='binomial')  
# glmm2<-glmer(T6~T2*rndm+(1|index_trial),data=df_et_agg_rja[df_et_agg_rja$rndm!='non autistic',],family='binomial')  
# anova(glmm1,glmm2)
# r2_nakagawa(glmm1)  
# r2_nakagawa(glmm2)  
# ###--> pic as random intercept has superior fit

#shape data
df_et_agg_rja<-df_trial[,names(df_trial) %in% c('pic','t','rja_any','rndm','index_trial')]
df_et_agg_rja<-reshape2::dcast(df_et_agg_rja,pic+rndm+index_trial~t,value.var='rja_any',fun.aggregate=any)

#intervention model
glmm<-glmer(T6~T2*rndm+(1|pic),data=df_et_agg_rja[df_et_agg_rja$rndm!='non autistic',],family='binomial')  
r2_nakagawa(glmm)  
confint(contrast(emmeans(glmm,~T2,type = "response"),'revpairwise'))
confint(contrast(emmeans(glmm,~T2|rndm,type = "response"),'revpairwise'))


#development model
glmm<-glmer(FU2~T2*rndm+(1|pic),data=df_et_agg_rja,family='binomial')  
r2_nakagawa(glmm)  
confint(contrast(emmeans(glmm,~T2|rndm,type = "response"),'revpairwise'))

```

### aggregated model

- used to compare to previous literature with paradigm of Senju & Csibra 2008

```{r}

df_et_agg$rja_difference<-with(df_et_agg,(rja_any-target_missed)/(rja_any+target_missed))
df_et_agg$rja_difference<-with(df_et_agg,ifelse((rja_any+target_missed)<3,NA,rja_difference))
hist(df_et_agg$rja_difference)

require(rstatix)

lm<-lm(rja_difference~t*rndm,data=df_et_agg[df_et_agg$t %in% c('T2','FU2'),])
anova(lm)    
  
lm<-anova_test(df_et_agg[df_et_agg$t %in% c('T2','FU2'),],rja_difference~t*rndm,wid=pic,within=t,type=3)
get_anova_table(lm)

lm<-aov(rja_difference~t*rndm,data=df_et_agg[df_et_agg$t %in% c('T2','FU2'),])
anova(lm)

lm<-aov(rja_difference~t*rndm,data=df_et_agg[df_et_agg$t %in% c('T2','T6') & df_et_agg$rndm!='non autistic',])
anova(lm)
      
      
lm<-aov(rja_any~t*rndm,data=df_et_agg[df_et_agg$t %in% c('T2','FU2'),])
anova(lm)
###--> not seen in aggregated data

lm<-lm(rja_any~t*rndm,data=df_et_agg[df_et_agg$t %in% c('T2','T6') & df_et_agg$rndm!='non autistic',])
anova(lm)
  
```

## gaze head duration as social attention

- significant increase in non-autistic and autistic A-FFIP  
gaze head predicts rja duration

```{r}

#association of social attention and RJA likelihood
df_trial$gazeduration_head_z<-scale(df_trial$gazeduration_head)
glmm<-glmer(rja_any~gazeduration_head_z+
            (1|pic)+(1|index_trial),data=df_trial,family='binomial')

r2_nakagawa(glmm)

summary(glmm)
cbind(round(fixef(glmm)['gazeduration_head_z'],2),
      round(confint(glmm,parm = 'gazeduration_head_z'),2))



#intervention model - 2 groups
lmm<-lmer(gazeduration_head~t*rndm+
            (1|pic)+(1|index_trial),data=df_trial[df_trial$t %in% c('T2','T6') & 
                                                    df_trial$rndm!='non autistic',])

r2_nakagawa(lmm)
confint(contrast(emmeans(lmm,~t|rndm),'revpairwise'))


#development model - 3 groups
lmm<-lmer(gazeduration_head_z~t*rndm+
            (1|pic)+(1|index_trial),data=df_trial[df_trial$t %in% c('T2','FU2'),])

r2_nakagawa(lmm)
emmeans(lmm,~t|rndm)
contrast(emmeans(lmm,~t|rndm),'revpairwise')
confint(contrast(emmeans(lmm,~t|rndm),'revpairwise'))
emmeans(lmm,~t|rndm)
###--> increase of social attention in non-autistic and autistic A-FFIP across timepoints

confint(contrast(emmeans(lmm,~rndm|t),'revpairwise'))


```

## baseline pupil size

- outcome measure: pupil size within first 500ms of video stimulus
- higher baseline PD is associated with lower RJA likelihood and social attention
- at FU: higher baseline PD in TAU compared to A-FFIp and non-autistic, but not at baseline

### effects on RJA measures

- higher baseline PD is associated with lower RJA likelihood and social attention

```{r}

df_trial$baseline_pd_z<-scale(df_trial$baseline_pd)
glmm<-glmer(rja_any~baseline_pd_z+
            (1|pic)+(1|index_trial),data=df_trial,family='binomial')

summary(glmm)
cbind(round(fixef(glmm)['baseline_pd_z'],2),
      round(confint(glmm,parm = 'baseline_pd_z'),2))


# lmm<-lmer(scale(gazeduration_head)~baseline_pd_z+
#             (1|pic)+(1|index_trial),data=df_trial)
# 
# r2_nakagawa(lmm)
# 
# 
# summary(lmm)
# 
# cbind(round(fixef(lmm)['baseline_pd_z'],2),
#       round(confint(lmm,parm = 'baseline_pd_z'),2))
# 

```

### intervention model - autism groups

- decrease of baseline PD in TAU 

```{r}

#intervention model
lmm<-lmer(baseline_pd_z~t*rndm+
            (1|pic)+(1|index_trial),data=df_trial[df_trial$t %in% c('T2','T6') & 
                                                    df_trial$rndm!='non autistic',])

r2_nakagawa(lmm)
contrast(emmeans(lmm,~t|rndm),'revpairwise')
confint(contrast(emmeans(lmm,~t|rndm),'revpairwise'))

contrast(emmeans(lmm,~rndm|t),'revpairwise')
confint(contrast(emmeans(lmm,~rndm|t),'revpairwise'))


```

### developmental model - between three groups

- at FU: higher baseline PD in TAU compared to A-FFIp and non-autistic, but not at baseline

```{r}

lmm<-lmer(baseline_pd_z~t*rndm+
            (1|pic)+(1|index_trial),data=df_trial[df_trial$t %in% c('T2','FU2'),])

r2_nakagawa(lmm)
contrast(emmeans(lmm,~t|rndm),'revpairwise')
confint(contrast(emmeans(lmm,~t|rndm),'revpairwise'))

contrast(emmeans(lmm,~rndm|t),'pairwise')
confint(contrast(emmeans(lmm,~rndm|t),'pairwise'))

```

## pupillary response

- measures:
  - rpd_early<- mean 1-2 seconds 
  - rpd_middle<- mean 4,5-5.5 seconds 
  - rpd_late<-mean 10-11 seconds 

- higher baseline PD is strongly associated with lower pupillary response
- pupillary response increases RJA likelihood and head attention
- higher pupillary response in TAU during FU compared to A-FFIp and non-autistic, not at baseline
  - this difference is not there for early and late pupillary response

### task effects on pupillary response (RPD) 

- rabbit is associated with stronger pupillary response

```{r}

lmm<-lmer(rpd_middle~condition+stimulus+position+
                  (1|pic)+(1|index_trial),data=df_trial[df_trial$t %in% c('T2','FU2'),])
      
anova(lmm)
contrast(emmeans(lmm,~stimulus),'pairwise')

```

### RPD effects on RJA

- pupillary response increases RJA likelihood

```{r}


df_trial$rpd_middle_z<-scale(df_trial$rpd_middle)
glmm<-glmer(rja_any~rpd_middle_z+
            (1|pic)+(1|index_trial),data=df_trial[df_trial$t %in% c('T2','FU2'),],family='binomial')

summary(glmm)
cbind(round(fixef(glmm)['rpd_middle_z'],2),
      round(confint(glmm,parm = 'rpd_middle_z'),2))

```

### RPD effect by baseline pupil size

-strong negative association

```{r}

lmm<-lmer(scale(rpd_middle)~baseline_pd_z+
            (1|pic)+(1|index_trial),data=df_trial)

summary(lmm)

cbind(round(fixef(lmm)['baseline_pd_z'],2),
      round(confint(lmm,parm = 'baseline_pd_z'),2))


r2_nakagawa(lmm)

```

### RPD effect on head gaze

- higher pupillary response associated with head attention
- probably by measurement effects

```{r}

lmm<-lmer(gazeduration_head~rpd_middle+
            (1|pic),data=df_trial)

anova(lmm)
fixef(lmm)

lmm<-glmer(rja_any~gazeduration_head*rpd_middle+
            (1|pic),data=df_trial,family='binomial')

anova(lmm)
fixef(lmm)

```

### RPD - two group, RCT analysis

- no effect

```{r}

lmm<-lmer(rpd_middle_z~t*rndm+
            (1|pic)+(1|index_trial),data=df_trial[df_trial$t %in% c('T2','T6') & 
                                                    df_trial$rndm!='non autistic',])
r2_nakagawa(lmm)
contrast(emmeans(lmm,~t|rndm),'revpairwise')
confint(contrast(emmeans(lmm,~t|rndm),'revpairwise'))

contrast(emmeans(lmm,~rndm|t),'pairwise')
confint(contrast(emmeans(lmm,~rndm|t),'pairwise'))

```

### RPD - three-group, follow-up analysis

- higher pupillary response in TAU during FU compared to A-FFIp and non-autistic, not at baseline
- this group difference even emphasized when considering baseline pupil size
- this difference is not there for early and late pupillary response

```{r}

lmm<-lmer(rpd_middle~t*rndm+
            (1|pic)+(1|index_trial),data=df_trial[df_trial$t %in% c('T2','FU2'),])

r2_nakagawa(lmm)
contrast(emmeans(lmm,~t|rndm),'pairwise')
confint(contrast(emmeans(lmm,~t|rndm),'pairwise'))

```

## causal mediation analysis

- signifiacnt causal mediation by BPS in the developmental model
- BPS mediates difference in RJA likelihood at follow-up between A-FFIP and TAU

### baseline pupil size as mediator

- for intervention model

```{r}

##causal mediation analysis
###--> only supports 1 level - one random intercept

df_trial$baseline_pd_z<-scale(df_trial$baseline_pd)
df_medanalysis<-df_trial[df_trial$t %in% c('T2','T6') & df_trial$rndm!='non autistic' & !is.na(df_trial$baseline_pd_z),]

glm_outcome<-glmer(rja_any~t*rndm+baseline_pd_z+
            (1|pic),
            data=df_medanalysis,family='binomial')

lmm_mod<-lme4::lmer(baseline_pd_z~t*rndm+
            (1|pic),data=df_medanalysis)

res<-mediation::mediate(lmm_mod,glm_outcome, 
                        treat = 'rndm', 
                        mediator='baseline_pd_z',
                        treat.value = 'autistic A-FFIP',
                        control.value = 'autistic TAU',
                        covariates = list(t = 'T6'), #check at T6
                        sims=1000)

summary(res)
plot(res)

```

- for development model

```{r}

##causal mediation analysis
###--> only supports 1 level - one random intercept

df_trial$baseline_pd_z<-scale(df_trial$baseline_pd)
df_medanalysis<-df_trial[df_trial$t %in% c('T2','FU2') & df_trial$rndm!='non autistic' & !is.na(df_trial$baseline_pd_z),]

glm_outcome<-glmer(rja_any~t*rndm+baseline_pd_z+
            (1|pic),
            data=df_medanalysis,family='binomial')

lmm_mod<-lme4::lmer(baseline_pd_z~t*rndm+
            (1|pic),data=df_medanalysis)

anova(glm_outcome)
anova(lmm_mod)

  glm_test<-glmer(rja_any~t*rndm+
            (1|pic),
            data=df_medanalysis,family='binomial')
  emmeans(glm_test,~rndm|t)

res<-mediation::mediate(lmm_mod,glm_outcome, 
                        treat = 'rndm', 
                        mediator='baseline_pd_z',
                        treat.value = 'autistic A-FFIP',
                        control.value = 'autistic TAU',
                        covariates = list(t = 'FU2'), #check at FU2
                        sims=1000)

#save(res,file=paste0(project_path,'/data/casual_mediation_baselinePD.Rdata'))
#load(paste0(project_path,'/data/casual_mediation_baselinePD.Rdata'))
###--> saved and loaded as simulation can lead to different results between iterations

summary(res)
plot(res)

```

### pupillary response as mediator

- for intervention model

```{r}

##causal mediation analysis
###--> only supports 1 level - one random intercept

df_trial$rpd_middle_z<-scale(df_trial$rpd_middle)
df_medanalysis<-df_trial[df_trial$t %in% c('T2','T6') & df_trial$rndm!='non autistic' & !is.na(df_trial$rpd_middle_z),]

glm_outcome<-glmer(rja_any~t*rndm+rpd_middle_z+
            (1|pic),
            data=df_medanalysis,family='binomial')

lmm_mod<-lme4::lmer(rpd_middle_z~t*rndm+
            (1|pic),data=df_medanalysis)

res<-mediation::mediate(lmm_mod,glm_outcome, 
                        treat = 'rndm', 
                        mediator='rpd_middle_z',
                        treat.value = 'autistic A-FFIP',
                        control.value = 'autistic TAU',
                        covariates = list(t = 'T6'), #check at FU2
                        sims=1000)

summary(res)
plot(res)

```

- for development model --> did not converge

```{r, eval=F}

##causal mediation analysis
###--> only supports 1 level - one random intercept

df_trial$rpd_middle_z<-scale(df_trial$rpd_middle)
df_medanalysis<-df_trial[df_trial$t %in% c('T2','FU2') & df_trial$rndm!='non autistic' & !is.na(df_trial$rpd_middle_z),]

glm_outcome<-glmer(rja_any~t*rndm+rpd_middle_z+
            (1|pic), data=df_medanalysis,family='binomial')

lmm_mod<-lme4::lmer(rpd_middle_z~t*rndm+
            (1|pic),data=df_medanalysis)

res<-mediation::mediate(lmm_mod,glm_outcome, 
                        treat = 'rndm', 
                        mediator='rpd_middle_z',
                        treat.value = 'autistic A-FFIP',
                        control.value = 'autistic TAU',
                        covariates = list(t = 'FU2'), #check at FU2
                        sims=1000)

#save(res,file=paste0(project_path,'/data/casual_mediation_SEPR.Rdata'))
load(paste0(project_path,'/data/casual_mediation_mediation_SEPR.Rdata'))
###--> saved and loaded as simulation can lead to different results between iterations

summary(res)
plot(res)

```

## developmental cascades

- potential variables available at FU: IQ, SRS, RBS, CBCL
- key variables not available at FU: ADOS, BOSCC

- change in RJA likelihood from T2-T6 predicts change in SRS score from T2-FU2
- However, small sample size

### create data set - wide format

```{r}

#data available for relevant data
with(demogr,table(!is.na(nonverbal_iq),t,rndm))
with(demogr,table(!is.na(verbal_iq),t,rndm))
with(demogr,table(!is.na(CBCL_T_GES),t,rndm))
with(demogr,table(!is.na(srs16_sum),t,rndm))
with(demogr,table(!is.na(RBSR_ges),t,rndm))

#add relevant variables to aggregated eye-tracking df
df_tmp<-dplyr::select(demogr,ID_Studie,t,nonverbal_iq,verbal_iq,CBCL_T_GES,srs16_sum,RBSR_ges)

table(df_tmp$t)
table(df_et_agg$t)

df_et_cascades<-df_et_agg[,!names(df_et_agg) %in%
                       c('nonverbal_iq','verbal_iq','CBCL_T_GES','srs16_sum','RBSR_ges')]

df_et_cascades<-merge(df_et_cascades,df_tmp,by.x=c('pic','t'),by.y=c('ID_Studie','t'),all.x=T)
df_et_cascades<-df_et_cascades[,!names(df_et_cascades) %in% c('Group.1','Group.2')]

### varaiables for different groups are in different imepoints
### thus, some merging is required 

#create data set for analysis
df_fu_measures_ASD<-df_et_cascades[df_et_cascades$t=='FU2' & df_et_cascades$rndm!='non autistic',names(df_et_cascades) %in% c('pic','rndm','nonverbal_iq','CBCL_T_GES','srs16_sum','RBSR_ges','verbal_iq')]

# non autistic follow-up data is labelled for a different timepoint:
df_fu_measures_TD<-demogr[demogr$t=='FU' & demogr$rndm=='non autistic',names(demogr) %in% c('ID_Studie','rndm','nonverbal_iq','CBCL_T_GES','srs16_sum','RBSR_ges','verbal_iq')]

names(df_fu_measures_ASD)<-c('pic','rndm',"nonverbal_iq_fu",'verbal_iq_fu',
                             "CBCL_T_GES_fu","srs16_sum_fu","RBSR_ges_fu")

names(df_fu_measures_TD)<-c('pic','rndm',"CBCL_T_GES_fu",
                            "srs16_sum_fu","RBSR_ges_fu",'verbal_iq_fu',"nonverbal_iq_fu")

df_fu_measures<-rbind(df_fu_measures_ASD,df_fu_measures_TD)
df_fu_measures<-df_fu_measures[!is.na(df_fu_measures$pic),]


df_bl_measures_ASD<-df_et_cascades[df_et_cascades$t=='T2'& df_et_cascades$rndm!='non autistic',
                          names(df_et_cascades) %in% c('pic','CBCL_T_GES','srs16_sum','RBSR_ges')]

df_bl_measures_TD<-demogr[demogr$t=='T1'& demogr$rndm=='non autistic',
                          names(demogr) %in% c('ID_Studie','CBCL_T_GES','srs16_sum','RBSR_ges')]

names(df_bl_measures_ASD)<-c('pic',"CBCL_T_GES_bl","srs16_sum_bl","RBSR_ges_bl")
names(df_bl_measures_TD)<-c('pic',"CBCL_T_GES_bl","srs16_sum_bl","RBSR_ges_bl")
df_bl_measures<-rbind(df_bl_measures_ASD,df_bl_measures_TD)

#get IQ baseline data
df_bl_measures_iq<-demogr[demogr$t=='T1',names(demogr) %in% c('ID_Studie','nonverbal_iq','verbal_iq')]
names(df_bl_measures_iq)<-c('pic',"verbal_iq_bl","nonverbal_iq_bl")

#get IQ T6 (end of intervention) data
df_t6_measures_iq<-demogr[demogr$t=='T6',names(demogr) %in% c('ID_Studie','nonverbal_iq','verbal_iq')]
names(df_t6_measures_iq)<-c('pic',"verbal_iq_t6","nonverbal_iq_t6")


#get RJA data at different imepoints
df_fu_rja<-df_et_cascades[df_et_cascades$t=='FU2',
                          names(df_et_cascades) %in% c('pic','rja_duration',
                                                                     'rja_any',
                                                                     'rja_occurances',
                                                                     'gazeduration_head',
                                                                     'time_to_target')]

df_t6_rja<-df_et_cascades[df_et_cascades$t=='T6',
                          names(df_et_cascades) %in% c('pic','rja_duration',
                                                                     'rja_any',
                                                                     'rja_occurances',
                                                                     'gazeduration_head',
                                                                     'time_to_target')]

df_t2_rja<-df_et_cascades[df_et_cascades$t=='T2',
                          names(df_et_cascades) %in% c('pic','rja_duration',
                                                                     'rja_any',
                                                                     'rja_occurances',
                                                                     'gazeduration_head',
                                                                     'time_to_target')]


names(df_fu_rja)<-c('pic',"time_to_target_fu","gazeduration_head_fu","rja_duration_fu",
                    "rja_any_fu","rja_occurances_fu")

names(df_t6_rja)<-c('pic',"time_to_target_t6","gazeduration_head_t6","rja_duration_t6",
                    "rja_any_t6","rja_occurances_t6")

names(df_t2_rja)<-c('pic',"time_to_target_t2","gazeduration_head_t2","rja_duration_t2",
                    "rja_any_t2","rja_occurances_t2")


#get pupillometry measures at timepoints
df_fu_pd<-df_et_cascades[df_et_cascades$t=='FU2',
                          names(df_et_cascades) %in% c('pic','baseline_pd',
                                                                     'rpd_middle')]

df_t6_pd<-df_et_cascades[df_et_cascades$t=='T6',
                          names(df_et_cascades) %in% c('pic','baseline_pd',
                                                                     'rpd_middle')]

df_t2_pd<-df_et_cascades[df_et_cascades$t=='T2',
                          names(df_et_cascades) %in% c('pic','baseline_pd',
                                                                     'rpd_middle')]


names(df_fu_pd)<-c('pic',"baseline_pd_fu","rpd_middle_fu")
names(df_t6_pd)<-c('pic',"baseline_pd_t6","rpd_middle_t6")
names(df_t2_pd)<-c('pic',"baseline_pd_t2","rpd_middle_t2")


#--> merge all
df_cascades<-merge(df_fu_measures,df_bl_measures,by='pic')
df_cascades<-merge(df_cascades,df_bl_measures_iq,by='pic')
df_cascades<-merge(df_cascades,df_t6_measures_iq,by='pic')
df_cascades$pic<-gsub('_K','',df_cascades$pic) #fix PIC 

df_cascades<-merge(df_cascades,df_fu_rja,by='pic',all.x = T)
df_cascades<-merge(df_cascades,df_t6_rja,by='pic',all.x = T)
df_cascades<-merge(df_cascades,df_t2_rja,by='pic',all.x = T)

df_cascades<-merge(df_cascades,df_fu_pd,by='pic',all.x = T)
df_cascades<-merge(df_cascades,df_t6_pd,by='pic',all.x = T)
df_cascades<-merge(df_cascades,df_t2_pd,by='pic',all.x = T)


##create difference measures
df_cascades$srs16_sum_diff_t2fu<-df_cascades$srs16_sum_fu-df_cascades$srs16_sum_bl
df_cascades$RBSR_ges_diff_t2fu<-df_cascades$RBSR_ges_fu-df_cascades$RBSR_ges_bl
df_cascades$nonverbal_iq_diff_t2fu<-df_cascades$nonverbal_iq_fu-df_cascades$nonverbal_iq_bl

df_cascades$rja_any_diff_t2t6<-df_cascades$rja_any_t6-df_cascades$rja_any_t2
df_cascades$rja_any_diff_t6fu<-df_cascades$rja_any_fu-df_cascades$rja_any_t6
df_cascades$rja_any_diff_fu_t2fu<-df_cascades$rja_any_fu-df_cascades$rja_any_t2

df_cascades$baseline_pd_diff_t2t6<-df_cascades$baseline_pd_t6-df_cascades$baseline_pd_t2
df_cascades$baseline_pd_diff_t6fu<-df_cascades$baseline_pd_fu-df_cascades$rja_any_t6
df_cascades$baseline_pd_diff_t2fu<-df_cascades$baseline_pd_fu-df_cascades$baseline_pd_t2

df_cascades$rpd_middle_diff_t2t6<-df_cascades$rpd_middle_t6-df_cascades$rpd_middle_t2
df_cascades$rpd_middle_diff_t6fu<-df_cascades$rpd_middle_fu-df_cascades$rpd_middle_t2
df_cascades$rpd_middle_diff_t2fu<-df_cascades$rpd_middle_fu-df_cascades$rpd_middle_t2



```

## developmental cascades analysis

```{r}



##association of developmental cascade measures and RJA change

summary(lm(scale(nonverbal_iq_diff_t2fu)~scale(rja_any_diff_t2t6),df_cascades))
summary(lm(scale(nonverbal_iq_diff_t2fu)~scale(baseline_pd_diff_t2t6),df_cascades))
summary(lm(scale(nonverbal_iq_diff_t2fu)~scale(rpd_middle_diff_t2t6),df_cascades))


df_cascades$rja_any_diff_t2t6_z<-scale(df_cascades$rja_any_diff_t2t6)
lm<-lm(scale(srs16_sum_diff_t2fu)~rja_any_diff_t2t6_z,df_cascades)
summary(lm)
confint(lm, 'rja_any_diff_t2t6_z', level=0.95)

with(df_cascades,table(is.na(srs16_sum_diff_t2fu),rndm))

df_cascades$rja_any_t6_z<-scale(df_cascades$rja_any_t6)
lm<-lm(scale(srs16_sum_fu)~rja_any_t6_z+scale(rja_any_t2),data=df_cascades)
summary(lm)
confint(lm, 'rja_any_t6_z', level=0.95)



summary(lm(scale(srs16_sum_diff_t2fu)~scale(baseline_pd_diff_t2t6),df_cascades))
summary(lm(scale(srs16_sum_diff_t2fu)~scale(rpd_middle_diff_t2t6),df_cascades))

summary(lm(scale(RBSR_ges_diff_t2fu)~scale(rja_any_diff_t2t6),df_cascades))
summary(lm(scale(RBSR_ges_diff_t2fu)~scale(baseline_pd_diff_t2t6),df_cascades))
summary(lm(scale(RBSR_ges_diff_t2fu)~scale(rpd_middle_diff_t2t6),df_cascades))






#change to FU
ggplot(df_et_cascades[df_et_cascades$FU_complete==T & df_et_cascades$rndm!='non autistic',],
       aes(x=t,y=rja_any/16*100,color=rndm,group=pic))+geom_point()+geom_line()

ggplot(df_et_cascades[df_et_cascades$rndm!='non autistic',],
       aes(x=t,y=rja_any/16*100,color=rndm,group=pic))+geom_point()+geom_line()
    

```



## normative model 

-create normative model based on non autistic data

```{r}

glmm<-glmer(rja_any~
                scale(baseline_pd)+
                #condition+position+
                #scale(fixation_duration)+scale(no_data)+
                gender+scale(t_age)+scale(baseline_nonverbal_iq)+
                (1|pic)+(1|index_trial),data=df_trial[df_trial$t %in% c('T2','FU2') &
                                                        df_trial$rndm=='non autistic',],
                                                  family='binomial')

summary(glmm)
###--> normative model defined by effects of gender, age at timepoint, baseline PD
r2_nakagawa(glmm)

#random effects
hist(unlist(ranef(glmm)$pic),10)
hist(ranef(glmm)$index_trial)


#predicted response as likelihood
df_trial$pred_rja_any<-predict(glmm, df_trial, type = 'response',
                               re.form= ~(1|pic)+(1|index_trial),
                               allow.new.levels=T)

# df_trial$pred_rja_any<-predict(glmm, df_trial, type = 'response',
#                                re.form= NA)

## calculate normative residual score
df_trial$res_rja_any<-with(df_trial,as.numeric(rja_any)-pred_rja_any)

hist(df_trial$pred_rja_any)
hist(df_trial$res_rja_any)
hist(df_trial$res_rja_any[df_trial$rja_any==T])


# df_trial$pred_rja_any<-predict(glmm, df_trial, type = 'response',
#                                re.form= NA)

### as a figure
ggplot(df_trial[df_trial$rndm %in% c('autistic A-FFIP','autistic TAU'),],
       aes(x=t_age,y=pred_rja_any))+
  geom_point(aes(color=rja_any,alpha=0.5))+
  geom_smooth()+
  facet_grid(~rndm)+
  scale_color_brewer(palette='Set1')

ggplot(df_trial[!is.na(df_trial$rndm),],
       aes(x=t_age,y=pred_rja_any))+
  geom_point(aes(color=rja_any,shape=rndm),alpha=0.5)+
  geom_smooth()+
  facet_grid(~rndm)+
  scale_color_brewer(palette='Set1')

ggplot(df_trial[!is.na(df_trial$rndm),],
       aes(x=baseline_pd,y=pred_rja_any))+
  geom_point(aes(color=rja_any,shape=rndm),alpha=0.5)+
  geom_smooth()+
  scale_color_brewer(palette='Set1')

#add to aggregated to evaluate performance

df_pred<-aggregate(df_trial[,names(df_trial)=='pred_rja_any'],
          by=list(df_trial$pic,df_trial$t),
          FUN=mean,na.rm=T)

names(df_pred)<-c('pic','t','pred_rja_any')

df_et_agg<-df_et_agg[,!names(df_et_agg) %in% c('Group.1','Group.2')]

df_et_agg<-merge(df_et_agg,df_pred,by=c('pic','t'),all.x=T)



```

### test normative model

- in intervention model

```{r}

lmm<-lmer(res_rja_any~t*rndm+
            (1|pic)+(1|index_trial),data=df_trial[df_trial$t %in% c('T2','T6') & 
                                                    df_trial$rndm!='non autistic' &
                                                    df_trial$rja_any==F,])

#model fit
r2_nakagawa(lmm)  

anova(lmm)
fixef(lmm)

#planned contrasts
contrast(emmeans(lmm,~rndm+t),'pairwise')

emmeans(lmm,~rndm)
contrast(emmeans(lmm,~rndm),'pairwise',adjust='none')
confint(contrast(emmeans(lmm,~rndm),'pairwise',adjust='none'))

```

- in developmental model

```{r}

#any
lmm<-lmer(res_rja_any~t*rndm+
            (1|pic)+(1|index_trial),data=df_trial[df_trial$t %in% c('T2','FU2') &
                                                    df_trial$rja_any==T,])

#model fit
r2_nakagawa(lmm)  
anova(lmm)
  
#planned contrasts
confint(contrast(emmeans(lmm,~t|rndm),'revpairwise'))
plot(emmeans(lmm,~t|rndm))
contrast(emmeans(lmm,~t|rndm),'revpairwise')

# comparsion at timepoints
confint(contrast(emmeans(lmm,~rndm|t),'pairwise'))
contrast(emmeans(lmm,~rndm|t),'pairwise')

```


# figures

## figure - material and measures

### figure prepare data set

```{r}
#prepare data set
df_jointatt_plot<-df_jointatt[df_jointatt$t %in% c('T2','T6','FU2'),]
levels(df_jointatt_plot$t)<-c('baseline','T4','end-of-treatent','follow-up','FU3')

#define joint attention phases
df_jointatt_plot$phase<-as.factor(with(df_jointatt_plot,dplyr::case_when(
  ts_event>300 &  ts_event<=1050 ~ 'intro direct gaze',
  ts_event>1050 &  ts_event<=2850 ~ 'target cueing',
  ts_event>2850 ~ 'outro direct gaze',
  )))

df_jointatt_plot$phase<-
  ordered(df_jointatt_plot$phase, levels = c("intro direct gaze", 
                                             "target cueing", 
                                             "outro direct gaze"))

#target position as factor
df_jointatt_plot$position<-as.factor(df_jointatt_plot$position)
levels(df_jointatt_plot$position)<-c('target left','target right')

```

### figure panel - RJA likelihood

```{r}

##RJA between timepoints and groups: density = count / n

# g_rja<-ggplot(df_jointatt_plot,
#        aes(x=rja_when/300,
#            group=t,fill=rndm))+
#   geom_density(adjust=1.5,trim=T)+
#   labs(x='trial duration (s)',y='')+
#   xlim(c(0,11))+
#   geom_vline(xintercept=1)+geom_vline(xintercept=3.5,linetype='dashed')+
#   geom_vline(xintercept=9.5,linetype='dashed')+
#   scale_fill_brewer(palette='Dark2')+
#   #facet_grid(rndm~t,scales = 'free_y')+theme_bw()
#   labs(fill='group',title = 'C.) RJA occurances (density)')+ #custom labels
#   facet_grid(t~rndm)+theme_bw()+
#   theme(legend.position = 'none')


 df_jointatt_plot$group_asd<-ifelse(df_jointatt_plot$rndm!='non autistic','autistic','non autistic')  
 g_rja<-ggplot(df_jointatt_plot,
       aes(x=rja_when/300,fill=rndm))+
  geom_density(adjust=2,trim=T,alpha=.7)+
  labs(x='trial duration (s)',y='')+
  xlim(c(0,11))+
  geom_vline(xintercept=1)+geom_vline(xintercept=3.5,linetype='dashed')+
  geom_vline(xintercept=9.5,linetype='dashed')+
  scale_fill_brewer(palette='Dark2')+
  #facet_grid(rndm~t,scales = 'free_y')+theme_bw()
  labs(fill='group',title = 'C.) RJA likelihood within trials (density)')+ #custom labels
  facet_grid(t~group_asd)+theme_bw()+
  theme(legend.position = 'none')


```

### figure panel - pupillometry

```{r}
##define percentage of data sampling for visualization
subsample<-sample(1:nrow(df_jointatt_plot),nrow(df_jointatt_plot)/sampling_factor) 
#--> select 10% of data for faster plotting (faster rendering)

#adapt data set for plotting
df_jointatt_plot_pupil<-df_jointatt_plot[subsample,]

# #pupil size progression - between conditions
# #--> between timepoints x groups
# g_pupil<-ggplot(df_jointatt_plot_pupil,
#        aes(x=ts_event/300,y=rpd,group=rndm,color=rndm))+
#   geom_smooth(aes(fill=rndm))+theme_bw()+
#   labs(title='D.) pupil size change (mm)',
#        x='trial duration (s)',
#        y='')+
#   geom_vline(xintercept=1)+geom_vline(xintercept=3.5,linetype='dashed')+ #mark video segments
#   geom_vline(xintercept=9.5,linetype='dashed')+ #mark video segments
#   scale_fill_brewer(palette='Dark2')+ #custom color
#   scale_color_brewer(palette='Dark2')+ #custom color
#   labs(color='group',fill='group')+ #custom labels
#   facet_grid(t~.)+
#   theme(legend.position = 'none')


#pupil size progression within complete trial across groups
g_pupil<-ggplot(df_jointatt_plot_pupil,
       aes(x=ts_event/300,y=pd))+
  geom_smooth(color='black',fill='darkgrey')+
  labs(title='D.) pupil size change within trials',
       x='trial duration (s)',
       y='pupil size (mm)')+
  geom_vline(xintercept=1)+geom_vline(xintercept=3.5,linetype='dashed')+ #mark video segments
  geom_vline(xintercept=9.5,linetype='dashed')+ #mark video segments
  annotate("rect", xmin = 0, xmax = 0.5, ymin = 4, ymax = 4.3, alpha = .2)+ #annotate BPS time span
  annotate("rect", xmin = 4.5, xmax = 5.5, ymin = 4, ymax = 4.3, alpha = .2)+ #annotate SEPR time span
  annotate(geom="text", x=0.25, y=4.3, label="BPS")+
  annotate(geom="text", x=5, y=4.3, label="SEPR")+
  coord_cartesian(ylim = c(4, 4.3))+
  #remove y axis title as later combioned to grob
  theme(axis.title.y=element_blank())

#baseline pupil size 
#select only attention grabber phase
df_jointatt_plot_bps<-df_jointatt_plot[df_jointatt_plot$ts_event<=300,]
g_bps<-ggplot(df_jointatt_plot_bps,aes(x=ts_event/300,y=pd))+
  geom_smooth(color='black',fill='darkgrey')+
  annotate("rect", xmin = 0, xmax = 0.5, ymin = 4, ymax = 4.25, alpha = .2)+
  labs(x='time in trial (s)',y='pupil size (mm)',title='E.) BPS: baseline size')+
  #remove y axis title as later combioned to grob
  theme(axis.title.y=element_blank())

#stimulus-evoked pupillary response
#select only gaze cued associated response
df_jointatt_plot_sepr<-df_jointatt_plot[df_jointatt_plot$ts_event>=1200 & df_jointatt_plot$ts_event<=1800,]
g_sepr<-ggplot(df_jointatt_plot_sepr,aes(x=ts_event/300,y=pd))+
  geom_smooth(color='black',fill='darkgrey')+
  annotate("rect", xmin = 4.5, xmax = 5.5, ymin = 4.15, ymax = 4.225, alpha = .2)+
  labs(x='time in trial (s)',y='pupil size (mm)',title='F.) SEPR: evoked response')+
  #remove y axis title as later combioned to grob
  theme(axis.title.y=element_blank())


```

### figure panel - heatmaps

```{r}


#define color
custom_palette<-brewer.pal(8,'Reds')[c(1,4,8)]

##define percentage of data sampling for visualization
subsample<-sample(1:nrow(df_jointatt_plot),nrow(df_jointatt_plot)/sampling_factor) 
#--> select 10% of data for faster plotting (faster rendering)

df_jointatt_plot_heatmap<-df_jointatt_plot[subsample,]
df_jointatt_plot_heatmap<-df_jointatt_plot_heatmap[!is.na(df_jointatt_plot_heatmap$phase),]

##gaze locations across video
g_gaze<-ggplot(df_jointatt_plot_heatmap,aes(x=gazepos_x,y=gazepos_y))+
  #geom_hex(bins=100)+
  stat_density_2d(aes(fill=after_stat(density)), n=100, geom = "raster", contour = FALSE)+
  #scale_fill_gradientn(colours=custom_palette)+
  scale_fill_gradientn(colours = c("red","red","orangered","orange","gold","yellow","green3","deepskyblue3",'white'),
                       values = c(1.0,0.5,0.2,0.15,0.1,0.07,0.05,0.02,0))+
  ylim(1,0)+xlim(0,1)+coord_fixed(ratio = 9/16)+
  labs(x='',y='',title='B.) gaze heatmap')+
  theme_classic()+
  facet_grid(position~phase)+
  theme(legend.position = 'none', 
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        panel.spacing = unit(.05, "lines"), #borders around every panel
        panel.border = element_rect(color = "black", fill = NA, size = 1),#borders 
        strip.background = element_rect(color = "black", size = 1)) #borders around every panel
  
    
```

### figure panel - stimulus material

loads image from file

```{r}
#read image - stimulus
require(magick)
img_data<-image_read(paste0(project_path,"/output/figure_material_stimulus.png"))
g_image<-image_ggplot(img_data)+labs(title='A.) trial phases')+
     annotate(geom = 'text',x=260,y=650,
              label='intro direct gaze',size=3,color='white')+
     annotate(geom = 'text',x=1550,y=650,
              label='target cueing',size=3,color='white')+
     annotate(geom = 'text',x=2930,y=650,
              label='outro direct gaze',size=3,color='white')

```


### figure composite

```{r}

#extract legend function
g_legend<-function(x){
  tmp <- ggplot_gtable(ggplot_build(x))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}

#temp plot
g1<-ggplot(df_jointatt_plot,
       aes(x=rja_when/300,
           group=t,fill=rndm))+
  geom_density(adjust=1.5,trim=T)+
  scale_fill_brewer(palette='Dark2')+
  labs(fill='group')+ #custom labels
  facet_grid(t~rndm)+theme_bw()+
  theme(legend.position = 'bottom')

#--> extract legend
mylegend<-g_legend(g1)

###--> plot figure

###--> print to file
#define size and resolution of the resulting figure
tiff(file=paste0(project_path,"/output/figures/figure_stimulus_material_revised.tiff"), 
     width=9, height=13, units="in", res=600, compression='lzw') 

# #plot to file
# grid.arrange(g_image,g_gaze,g_rja,g_pupil,mylegend,
#              widths= c(1,2,2), # composite 3 and 4 in relation of 3:2
#              heights = c(2,2,2,4,2,1),
#              layout_matrix = rbind(c(1,1,1),
#                                    c(2,2,2),
#                                    c(2,2,2),
#                                    c(3,3,4),
#                                    c(3,3,4),
#                                    c(5,5,5)))

#plot to file
grob_pupil<-arrangeGrob(g_pupil,g_bps,g_sepr,ncol=1,left='pupil size (mm)')
grid.arrange(g_image,g_gaze,g_rja,grob_pupil,mylegend,
             widths= c(1,2,2), # composite 3 and 4 in relation of 3:2
             heights = c(2,2,2,3,3,3,1),
             layout_matrix = rbind(c(1,1,1),
                                   c(2,2,2),
                                   c(2,2,2),
                                   c(3,3,4),
                                   c(3,3,4),
                                   c(3,3,4),
                                   c(5,5,5)))


#close operation and save file
dev.off() 


```


## figure - RJA, BPS, SEPR between timepoints

### violin plot panel

```{r}

#create data set aggregated by participant for RJA
df_trial_plot<-df_trial[df_trial$t %in% c('T2','T6','FU2') & !is.na(df_trial$rndm),]
rja_any_sum<-as.numeric(with(df_trial_plot,
                             by(rja_any,droplevels(interaction(rndm,t,id)),sum)))
rja_n<-as.numeric(with(df_trial_plot,
                             by(rja_any,droplevels(interaction(rndm,t,id)),length)))
bps_n<-as.numeric(with(df_trial_plot,
                             by(baseline_pd,
                                droplevels(interaction(rndm,t,id)),mean,na.rm=T)))
sepr_n<-as.numeric(with(df_trial_plot,
                             by(rpd_middle,
                                droplevels(interaction(rndm,t,id)),mean,na.rm=T)))
rndm<-as.factor(with(df_trial_plot,
                             by(rndm,droplevels(interaction(rndm,t,id)),head,n=1)))
levels(rndm)<-levels(df_trial$rndm)
t<-as.factor(with(df_trial_plot,
                             by(t,droplevels(interaction(rndm,t,id)),head,n=1)))
levels(t)<-c('baseline','end-of-treatment','follow-up')
id<-as.factor(with(df_trial_plot,
                             by(id,droplevels(interaction(rndm,t,id)),head,n=1)))

df_trial_plot_rja<-data.frame(rja_any_sum,bps_n,sepr_n,rja_n,rndm,t,id)

#plot RJA 
g_rja<-ggplot(df_trial_plot_rja,aes(x=rndm,y=rja_any_sum/rja_n*100,fill=rndm))+
  geom_violin(width=1,trim=T) +
  geom_boxplot(width=0.2, color="grey", alpha=0.2)+
  scale_fill_brewer(palette='Dark2')+
  labs(x='group',y='RJA likelihood (%)',fill='group')+
  theme(axis.text.x = element_blank())+
  facet_grid(.~t)


#plot BPS
g_bps<-ggplot(df_trial_plot_rja,aes(x=rndm,y=bps_n,fill=rndm))+
  geom_violin(width=1,trim=T) +
  geom_boxplot(width=0.2, color="grey", alpha=0.2)+
  scale_fill_brewer(palette='Dark2')+
  labs(x='group',y='BPS (mm) \n',fill='group')+
  theme(axis.text.x = element_blank())+
  facet_grid(.~t)

#plot SEPR
g_sepr<-ggplot(df_trial_plot_rja,aes(x=rndm,y=sepr_n,fill=rndm))+
  geom_violin(width=1,trim=T) +
  geom_boxplot(width=0.2, color="grey", alpha=0.2)+
  scale_fill_brewer(palette='Dark2')+
  labs(x='group',y='SEPR (mm)',fill='group')+
  theme(axis.text.x = element_blank())+
  facet_grid(.~t)

#extract legend
#extract legend function
g_legend<-function(x){
  tmp <- ggplot_gtable(ggplot_build(x))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}

#temp plot
g1<-ggplot(df_trial_plot_rja,aes(x=rndm,y=rja_any_sum/rja_n*100,fill=rndm))+
  geom_violin(width=1,trim=T) +
  geom_boxplot(width=0.2, color="grey", alpha=0.2)+
  labs(fill='group')+
  scale_fill_brewer(palette='Dark2')+
  theme(legend.position = 'bottom')
  
#--> extract legend
mylegend<-g_legend(g1)

```

### panel scatterplot

```{r}
### figure panel association with RJA

df_plot<-df_et_agg[df_et_agg$t %in% c('T2','T6','FU2') & !is.na(df_et_agg$rndm),]

g_age_rja<-ggplot(df_plot,aes(x=t_age,y=rja_any/16*100,color=rndm,fill=rndm))+
  geom_point(aes(shape=t))+
  geom_smooth(method='lm')+
  scale_color_brewer(palette='Dark2')+
  scale_fill_brewer(palette='Dark2')+
  ylim(c(0,100))+
  labs(x='age (months)',y='RJA likelihood (%)')+
  theme(legend.position = 'none')+
  facet_grid(~rndm)

g_bps_rja<-ggplot(df_plot,aes(x=baseline_pd,y=rja_any/16*100,color=rndm,fill=rndm))+
  geom_point(aes(shape=t))+
  geom_smooth(method='lm')+
  scale_color_brewer(palette='Dark2')+
  scale_fill_brewer(palette='Dark2')+
  #xlim(c(3,6))+
  ylim(c(0,100))+
  labs(x='BPS (mm)',y='RJA likelihood (%)')+
  theme(legend.position = 'none')+
  facet_grid(~rndm)

g_sepr_rja<-ggplot(df_plot,aes(x=rpd_middle,y=rja_any/16*100,color=rndm,fill=rndm))+
  geom_point(aes(shape=t))+
  geom_smooth(method='lm')+
  scale_color_brewer(palette='Dark2')+
  scale_fill_brewer(palette='Dark2')+
  #xlim(c(-0.5,0.5))+
  ylim(c(0,100))+
  labs(x='SEPR (mm)',y='RJA likelihood (%)')+
  theme(legend.position = 'none')+
  facet_grid(~rndm)

#temp plot
g1<-ggplot(df_plot,aes(x=t_age,y=rja_any))+
  geom_point(aes(shape=t))+
  labs(shape='timepoint')+
  scale_shape_manual(labels=c("baseline","end-of-treatment","follow-up"),
                     values=c(16,17,15))+
  theme(legend.position = 'bottom')
  
#--> extract legend
mylegend2<-g_legend(g1)

```

### print figure

```{r}

grid.arrange(g_rja+
               theme(legend.position = 'none',
                     axis.title.x = element_blank(),
                     axis.ticks.x = element_blank()),
             
             g_age_rja,
             
             g_bps+
               theme(legend.position = 'none',
                     axis.title.x = element_blank(),
                     axis.ticks.x = element_blank()),
             
             g_bps_rja,
             
             g_sepr+
               theme(legend.position = 'none',
                     axis.title.x = element_blank(),
                     axis.ticks.x = element_blank()),
             
             g_sepr_rja,
             
             mylegend,
             
             mylegend2,
             
             ncol=2,
             heights=c(3,3,3,1))



###--> print to file
#define size and resolution of the resulting figure
tiff(file=paste0(project_path,"/output/figures/figure_measures_by_group2.tiff"), 
     width=10, height=6, units="in", res=600, compression='lzw') 

# grid.arrange(g_rja+
#                theme(legend.position = 'none',
#                      axis.title.x = element_blank(),
#                      axis.ticks.x = element_blank()),
#              g_bps+
#                theme(legend.position = 'none',
#                      axis.title.x = element_blank(),
#                      axis.ticks.x = element_blank()),
#              g_sepr+
#                theme(legend.position = 'none',
#                      axis.title.x = element_blank(),
#                      axis.ticks.x = element_blank()),
#              mylegend,
#              ncol=1,
#              heights=c(3,3,3,1))

grid.arrange(g_rja+
               theme(legend.position = 'none',
                     axis.title.x = element_blank(),
                     axis.ticks.x = element_blank()),
             
             g_age_rja,
             
             g_bps+
               theme(legend.position = 'none',
                     axis.title.x = element_blank(),
                     axis.ticks.x = element_blank()),
             
             g_bps_rja,
             
             g_sepr+
               theme(legend.position = 'none',
                     axis.title.x = element_blank(),
                     axis.ticks.x = element_blank()),
             
             g_sepr_rja,
             
             mylegend,
             
             mylegend2,
             
             ncol=2,
             heights=c(3,3,3,1))

#close operation and save file
dev.off() 

```


## figure - developmental cascade

figure caption: Cascade effects - Assocation of changes in RJA likelihood and BPS from baseline (BL) to end-of-treatment (ET) on socio cognitive development. Socio-cognitive development is measured by changes from baseline (BL) to follow-up (FU) in social responsiveness (SRS-16 total score), repetitive behavior (RBSR total score), and nonverbal IQ change (Bayley III or WPPSI).

```{r}

#extract legend function
g_legend<-function(x){
  tmp <- ggplot_gtable(ggplot_build(x))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}

#temp plot
g1<-ggplot(df_cascades[df_cascades$rndm!='non autistic',],
       aes(rja_any_diff_t2t6/16*100,nonverbal_iq_diff_t2fu))+geom_point(aes(color=rndm))+
  geom_smooth(color='darkgrey',method='lm',show.legend = F)+
  scale_color_brewer(palette='Dark2')+
  labs(color='group')
  
#--> extract legend
mylegend<-g_legend(g1)



g1<-ggplot(df_cascades[df_cascades$rndm!='non autistic',],
       aes(rja_any_diff_t2t6/16*100,nonverbal_iq_diff_t2fu))+
  geom_point(aes(size=2,color=rndm))+
  geom_smooth(color='darkgrey',method='lm',show.legend = F)+
  xlab('RJA likelihood change (ET - BL)')+
  scale_color_brewer(palette='Dark2')+
  theme(legend.position = 'none',axis.title.y=element_blank())

g2<-ggplot(df_cascades[df_cascades$rndm!='non autistic',],
       aes(baseline_pd_diff_t2t6,nonverbal_iq_diff_t2fu))+
  geom_point(aes(size=2,color=rndm))+
  geom_smooth(color='darkgrey',method='lm',show.legend = F)+
  xlab('BPS change (ET - BL)')+
  #annotate(geom="text", x=0, y=30, label="n.s.", color='blue')+
  scale_color_brewer(palette='Dark2')+
  theme(legend.position = 'none',axis.title.y=element_blank())

g3<-ggplot(df_cascades[df_cascades$rndm!='non autistic',],
       aes(rja_any_diff_t2t6/16*100,srs16_sum_diff_t2fu))+
  geom_point(aes(size=2,color=rndm))+
  geom_smooth(color='darkgrey',method='lm',show.legend = F)+
  xlab('RJA likelihood change (ET - BL)')+
  annotate(geom="text", x=0, y=20, label="-1.01*", color='black')+
  scale_color_brewer(palette='Dark2')+
  theme(legend.position = 'none',axis.title.y=element_blank())

g4<-ggplot(df_cascades[df_cascades$rndm!='non autistic',],
       aes(baseline_pd_diff_t2t6,srs16_sum_diff_t2fu))+
  geom_point(aes(size=2,color=rndm))+
  geom_smooth(color='darkgrey',method='lm',show.legend = F)+
  xlab('BPS change (ET - BL)')+
  annotate(geom="text", x=0, y=20, label="-0.79'", color='black')+
  scale_color_brewer(palette='Dark2')+
  theme(legend.position = 'none',axis.title.y=element_blank())

g5<-ggplot(df_cascades[df_cascades$rndm!='non autistic',],
       aes(rja_any_diff_t2t6/16*100,RBSR_ges_diff_t2fu))+
  geom_point(aes(size=2,color=rndm))+
  geom_smooth(color='darkgrey',method='lm',show.legend = F)+
  xlab('RJA likelihood change (ET - BL)')+
  annotate(geom="text", x=0, y=25, label="-0.60'", color='black')+
  scale_color_brewer(palette='Dark2')+
  theme(legend.position = 'none',axis.title.y=element_blank())

g6<-ggplot(df_cascades[df_cascades$rndm!='non autistic',],
       aes(baseline_pd_diff_t2t6,RBSR_ges_diff_t2fu))+
  geom_point(aes(size=2,color=rndm))+
  geom_smooth(color='darkgrey',method='lm',show.legend = F)+
  xlab('BPS change (ET - BL)')+
  annotate(geom="text", x=0, y=20, label="", color='blue')+
  scale_color_brewer(palette='Dark2')+
  theme(legend.position = 'none',axis.title.y=element_blank())

g12<-grid.arrange(g1,g2,left='nonverbal IQ change (FU - BL)')
g34<-grid.arrange(g3,g4,left='social responsiveness change (FU - BL)')
g56<-grid.arrange(g5,g6,left='repetitive behavior change (FU - BL)')

#plot in markdown
grid.arrange(g34,g56,g12,mylegend,ncol=4,widths=c(2,2,2,1))

##save to file
# create a file in tiff format in current working directory
#define size and resolution of the resulting figure
tiff(file=paste0(project_path,"/output/figures/figure_cascades.tiff"), 
     width=10, height=5, units="in", res=300, compression='lzw') 

#plot to file
grid.arrange(g34,g56,g12,mylegend,ncol=4,widths=c(2,2,2,1))

#close operation and save file
dev.off() 

```


# supplements

## supplement - figure distributions

- per sample data figure

```{r}

hist(df_jointatt$pd)

ggplot(df_jointatt,aes(x=pd))+geom_histogram(bins=50)+
  labs(x='',y='observations (n)',title='pupil size (mm)')

```

## supplement - random effect distribution

```{r}

##in intervention model
glmm<-glmer(rja_any~t*rndm+
            (1|pic)+(1|index_trial),data=df_trial[df_trial$t %in% c('T2','T6') & 
                                                    df_trial$rndm!='non autistic',],family='binomial')

#random effect distribution
df_plot<-data.frame(scale(ranef(glmm)$pic))
g_re1<-ggplot(df_plot,aes(x=X.Intercept.))+geom_histogram(color='grey',bins=20)+
  labs(x='Intervention model: Heterogeneity in RJA (participant random intercept, z)')


#development model
glmm<-glmer(rja_any~t*rndm+
            (1|pic)+(1|index_trial),data=df_trial[df_trial$t %in% c('T2','FU2'),],family='binomial')

#random effect distribution
df_plot<-data.frame(scale(ranef(glmm)$pic))
g_re2<-ggplot(df_plot,aes(x=X.Intercept.))+geom_histogram(color='grey',bins=20)+
  labs(x='Development model: Heterogeneity in RJA (participant random intercept, z)')

#define size and resolution of the resulting figure
tiff(file=paste0(project_path,"/output/supplements/figure_particiopant_random_effect.tiff"), 
     width=6, height=8, units="in", res=600, compression='lzw') 

grid.arrange(g_re1,g_re2)

dev.off()

```



## supplement - date of assessment

```{r}

table(demogr$t)

demogr_sup<-demogr[demogr$t %in% c('T2','T6','FU2'),]
demogr_sup$timepoint<-droplevels(as.factor(demogr_sup$t))
levels(demogr_sup$timepoint)<-c('baseline','end-of-treatment','follow-up')

# ggplot(demogr_sup[!is.na(demogr_sup$t_date)& !is.na(demogr_sup$rndm),],aes(x=t_date,fill=timepoint))+
#   geom_histogram(bins=50)+theme_bw()+
#   labs(title='assessments across study runtime')+labs(x='date of assessment')

tiff(file=paste0(project_path,"/output/supplements/figure_date_of_assessment.tiff"), 
     width=12, height=4, units="in", res=600, compression='lzw') 


ggplot(demogr_sup[!is.na(demogr_sup$t_date) & !is.na(demogr_sup$rndm),],aes(x=ID_Bado,y=t_date,color=timepoint))+
  geom_point()+theme_bw()+labs(x='participant',y='date of assessment')+
  labs(title='assessments across study runtime')+
  facet_wrap(~rndm)+
  scale_color_brewer(palette='Dark2')+
  theme(axis.text.x = element_blank())

dev.off()

```


## supplement - drop out analysis 

- participants that completed the RCT or FU did not differ on autism symptom severity, general psychopathology, or eye-tracking data quality

### RJA likelihood eye-tracking

```{r}

#one value per timepoint and participant
df_sample<-df_et_agg[df_et_agg$t=='T2',]
df_sample<-df_sample[!duplicated(df_sample$pic),]

with(df_sample[df_sample$rndm!='non autistic',],psych::describeBy(rja_any,RCT_complete))
anova(lm(rja_any~RCT_complete*rndm,data=df_sample[df_sample$rndm!='non autistic',]))

with(df_sample[df_sample$rndm!='non autistic',],psych::describeBy(rja_any,FU_complete))

descriptives_table<-round(anova(lm(rja_any~FU_complete*rndm,
                             data=df_sample[df_sample$rndm!='non autistic',])),2)

var_names<-c('retention status (RS)','autistic group (G)','RS x G','Residuals')

#create table
descriptives_table<-cbind(var_names,descriptives_table)

table_sample<-descriptives_table %>%
  kbl(caption = "RJA likelihood: Effect of retention status and autistic group at baseline.",
      col.names = c('','DF','Sum Sq','Mean Sq','F-value','p-value'),
      row.names = F) %>%
  kable_classic(full_width = F, html_font = "Cambria")

table_sample

save_kable(table_sample, file=paste0(project_path,'/output/supplements/dropout_RJAlikelihood.html'))


```

### autism symptom severity

```{r}

#one value per timepoint and participant
df_sample<-df_trial[df_trial$t=='T2',]
df_sample<-df_sample[!duplicated(df_sample$pic),]

with(df_sample[!duplicated(df_sample$pic),],table(rndm,FU_complete))
with(df_sample[!duplicated(df_sample$pic),],table(rndm,RCT_complete))

with(df_sample[df_sample$rndm!='non autistic',],psych::describeBy(Severity_Gesamt,RCT_complete))
anova(lm(Severity_Gesamt~RCT_complete*rndm,data=df_sample[df_sample$rndm!='non autistic',]))

with(df_sample[df_sample$rndm!='non autistic',],psych::describeBy(Severity_Gesamt,FU_complete))

descriptives_table<-round(anova(lm(Severity_Gesamt~FU_complete*rndm,
                                   data=df_sample[df_sample$rndm!='non autistic',])),2)

var_names<-c('retention status (RS)','autistic group (G)','RS x G','Residuals')

#create table
descriptives_table<-cbind(var_names,descriptives_table)

table_sample<-descriptives_table %>%
  kbl(caption = "Autism symptom severity: Effect of retention status and autistic group at baseline.",
      col.names = c('','DF','Sum Sq','Mean Sq','F-value','p-value'),
      row.names = F) %>%
  kable_classic(full_width = F, html_font = "Cambria")

table_sample

save_kable(table_sample, file=paste0(project_path,'/output/supplements/dropout_symptomseverity.html'))

```

### comorbid psychopathology

```{r}

#one value per timepoint and participant
df_sample<-df_trial[df_trial$t=='T2',]
df_sample<-df_sample[!duplicated(df_sample$pic),]

with(df_sample[df_sample$rndm!='non autistic',],psych::describeBy(CBCL_T_GES,RCT_complete))
anova(lm(CBCL_T_GES~RCT_complete*rndm,data=df_sample[df_sample$rndm!='non autistic',]))

with(df_sample[df_sample$rndm!='non autistic',],psych::describeBy(CBCL_T_GES,FU_complete))


descriptives_table<-round(anova(lm(CBCL_T_GES~FU_complete*rndm,
                                   data=df_sample[df_sample$rndm!='non autistic',])),2)

var_names<-c('retention status (RS)','autistic group (G)','RS x G','Residuals')

#create table
descriptives_table<-cbind(var_names,descriptives_table)

table_sample<-descriptives_table %>%
  kbl(caption = "Comorbid Psychopathology: Effect of retention status and autistic group at baseline.",
      col.names = c('','DF','Sum Sq','Mean Sq','F-value','p-value'),
      row.names = F) %>%
  kable_classic(full_width = F, html_font = "Cambria")

table_sample

save_kable(table_sample, file=paste0(project_path,'/output/supplements/dropout_psychopathology.html'))


```

### eye tracking data quality

```{r}

df_sample<-df_et_agg[df_et_agg$t=='T2',]

with(df_sample,psych::describeBy(no_data,interaction(rndm,FU_complete)))
anova(lm(no_data~FU_complete*rndm,data=df_sample))

with(df_sample[df_sample$rndm!='non autistic',],psych::describeBy(no_data,RCT_complete))


descriptives_table<-round(anova(lm(no_data~FU_complete*rndm,
                                   data=df_sample[df_sample$rndm!='non autistic',])),2)

var_names<-c('retention status (RS)','autistic group (G)','RS x G','Residuals')

#create table
descriptives_table<-cbind(var_names,descriptives_table)

table_sample<-descriptives_table %>%
  kbl(caption = "Data quality as missing data: Effect of retention status and autistic group at baseline.",
      col.names = c('','DF','Sum Sq','Mean Sq','F-value','p-value'),
      row.names = F) %>%
  kable_classic(full_width = F, html_font = "Cambria")

table_sample

save_kable(table_sample, file=paste0(project_path,'/output/supplements/dropout_dataquality.html'))


```

## post-hoc power calculation

```{r}

#one value per timepoint and participant
df_sample<-df_trial[df_trial$t=='T2',]
df_sample<-df_sample[!duplicated(df_sample$pic),]
df_sample<-df_sample[df_sample$rndm!='non autistic',]

pwrss.f.ancova(eta2 = 0.12,  #moderate effect size
               n.levels = c(2,2), #factor levels in two way anova
               alpha = 0.05, 
               n = nrow(df_sample), #sample size
               power = NULL)

```



